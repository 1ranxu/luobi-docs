# LuoBI

## é¡¹ç›®ä»‹ç»

**BIï¼ˆå•†ä¸šæ™ºèƒ½ï¼‰ï¼š**æ•°æ®å¯è§†åŒ–ï¼ŒæŠ¥è¡¨å¯è§†åŒ–ç³»ç»Ÿ

**ä¸»æµBIï¼š**

- å¸†è½¯BI https://www.finebi.com
- å°é©¬BI https://bi.zhls.qq.com
- PowerBI https://powerbi.microsoft.com/zh-cn 

**ä¼ ç»ŸBIï¼š**

https://chartcube.alipay.com

1. éœ€è¦äººå·¥ä¸Šä¼ æ•°æ®
2. éœ€è¦äººå·¥é€‰æ‹©æ•°æ®çš„è¡Œå’Œåˆ—è¿›è¡Œåˆ†æï¼ˆæ•°æ®åˆ†æå¸ˆï¼‰
3. éœ€è¦äººå·¥é€‰æ‹©å›¾è¡¨ç±»å‹ï¼ˆæ•°æ®åˆ†æå¸ˆï¼‰
4. ç”Ÿæˆå›¾è¡¨ï¼ˆä¿å­˜é…ç½®ï¼‰

**æ™ºèƒ½BIå¹³å°ï¼š**

1. ç”¨æˆ·ï¼ˆæ•°æ®åˆ†æè€…ï¼‰åªéœ€è¦å¯¼å…¥åŸå§‹æ•°æ®ï¼Œè¾“å…¥æƒ³è¦åˆ†æçš„ç›®æ ‡ï¼ˆæ¯”å¦‚â€å¸®æˆ‘åˆ†æä»¥ä¸‹ç½‘ç«™çš„ç”¨æˆ·å¢é•¿è¶‹åŠ¿â€œï¼‰ï¼Œå°±èƒ½åˆ©ç”¨AIè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç¬¦åˆè¦æ±‚çš„å›¾è¡¨ä»¥åŠç»“è®º
2. ä¸ä¼šæ•°æ®åˆ†æçš„ç”¨æˆ·ï¼Œä¹Ÿèƒ½é€šè¿‡è¾“å…¥ç›®æ ‡å¿«é€Ÿå®Œæˆæ•°æ®åˆ†æï¼Œå¤§å¹…èŠ‚çº¦äººåŠ›æˆæœ¬

## éœ€æ±‚åˆ†æ

1. æ™ºèƒ½åˆ†æï¼šç”¨æˆ·è¾“å…¥ç›®æ ‡ï¼ŒåŸå§‹æ•°æ®å’Œå…¶ä»–å‚æ•°ï¼ˆå¦‚å›¾è¡¨ç±»å‹ï¼‰ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨å’Œç»“è®º
2. å›¾è¡¨ç®¡ç†
3. å›¾è¡¨ç”Ÿæˆçš„å¼‚æ­¥åŒ–ï¼ˆæ¶ˆæ¯é˜Ÿåˆ— ï¼‰
4. å¯¹æ¥ AI 

## æ¶æ„å›¾

![image-20231030214212882](assets/image-20231030214212882.png)

## æŠ€æœ¯é€‰æ‹©

**å‰ç«¯ï¼š**

- React
- Ant Design Pro
- Umi
- ECharts å¯è§†åŒ–å¼€å‘åº“
- umi openapi ä»£ç ç”Ÿæˆï¼ˆè‡ªåŠ¨ç”Ÿæˆåç«¯è°ƒç”¨ä»£ç ï¼‰

**åç«¯ï¼š**

- Spring Bootï¼ˆä¸‡ç”¨ Java åç«¯é¡¹ç›®æ¨¡æ¿ï¼‰
- MySQL
- MyBatis Plus
- RabbitMQ
- AI èƒ½åŠ›ï¼ˆOpen AI æ¥å£å¼€å‘/ ä½¿ç”¨ç°æˆçš„ AI æ¥å£ï¼‰
- EasyExcelï¼ˆExcel çš„ä¸Šä¼ å’Œæ•°æ®çš„è§£æï¼‰
- Swagger + Knife4j
- Hutool

## è®¡åˆ’

**åˆå§‹åŒ–**

- å‰ç«¯
- åç«¯

**åç«¯**

- æ•°æ®åº“è¡¨è®¾è®¡
- è‡ªåŠ¨ç”Ÿæˆå¢åˆ æ”¹æŸ¥ä»£ç 
- å›¾è¡¨ç®¡ç†
- æ™ºèƒ½å›¾è¡¨åˆ†æ
- ç³»ç»Ÿä¼˜åŒ–
  - å®‰å…¨æ€§
  - æ•°æ®å­˜å‚¨
  - é™æµ
  - å¼‚æ­¥åŒ–

- åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—

**å‰ç«¯**

- è‡ªåŠ¨ç”Ÿæˆåç«¯è°ƒç”¨ä»£ç 
- ä¿®æ”¹requestErrorConfig

- ç™»å½•æ³¨å†Œé¡µé¢
- æ™ºèƒ½å›¾è¡¨åˆ†æé¡µé¢
- ä¸ªäººå›¾è¡¨é¡µé¢

## åˆå§‹åŒ–

### å‰ç«¯

#### åˆå§‹åŒ–

https://pro.ant.design/

1. åˆ›å»ºé¡¹ç›®

```sh
# ä½¿ç”¨ npmï¼Œ
npm i @ant-design/pro-cli -g
pro create luobi-frontend
```

![image-20231031101557449](assets/image-20231031101557449.png)

2. å®‰è£…ä¾èµ–

```
yarn
```

![image-20231031102623399](assets/image-20231031102623399.png)

3. å»é™¤å›½é™…åŒ–

![image-20231031105510481](assets/image-20231031105510481.png)

[ğŸ› [BUG\] æ‰§è¡Œåˆ é™¤å›½é™…åŒ–å‘½ä»¤æŠ¥é”™ Â· Issue #10452 Â· ant-design/ant-design-pro (github.com)](https://github.com/ant-design/ant-design-pro/issues/10452)

![image-20231031105637111](assets/image-20231031105637111.png)

```sh
yarn add eslint-config-prettier --dev yarn add eslint-plugin-unicorn --dev 
```

![image-20231031105714817](assets/image-20231031105714817.png)

![image-20231031105729743](assets/image-20231031105729743.png)

å†æ¬¡æ‰§è¡Œå»é™¤å›½é™…åŒ–å°±èƒ½æˆåŠŸäº†

![image-20231031105849430](assets/image-20231031105849430.png)

#### ç»“æ„ä»‹ç»

- .huskyï¼šæäº¤ä»£ç æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦è§„èŒƒ
- config
  - config.tsï¼šæ ¸å¿ƒé…ç½®æ–‡ä»¶
  - defaultSettings.tsï¼šä¸»é¡µé¡µé¢çš„æ’ç‰ˆå’Œé¢œè‰²ç­‰è®¾ç½®
  - openapi.jsonï¼šåªæ˜¯ç¤ºä¾‹æ•°æ®ï¼Œæ— ç”¨å¯åˆ é™¤
  - proxy.tsï¼šä»£ç†
  - routes.tsï¼šè·¯ç”±
- mockï¼šæ¨¡æ‹Ÿæ•°æ®ï¼Œæ— ç”¨å¯åˆ é™¤
- public
  - iconsï¼šå›¾æ ‡logoï¼Œæ— ç”¨å¯åˆ é™¤
  - scriptsï¼šä¸çŸ¥é“
  - CNAMEï¼šä¸ç”¨ç®¡
  - favicon.icoï¼šç½‘ç«™å·¦ä¸Šè§’å°å›¾æ ‡ https://www.iconfont.cn
  - logo.svgï¼šæ›¿æ¢æˆè‡ªå·±çš„logohttps://www.iconfont.cn
  - pro_icon.svgï¼šæ— ç”¨åˆ é™¤
- src
  - .umiï¼šå¸¦ç‚¹çš„æ˜¯éšè—æ–‡ä»¶ï¼Œæ¡†æ¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸ç”¨ç®¡
  - componentsï¼šéœ€è¦å¼€å‘çš„ç»„ä»¶
  - localesï¼šå›½é™…åŒ–ï¼Œæ— ç”¨å¯åˆ é™¤
  - pagesï¼šéœ€è¦å¼€å‘çš„é¡µé¢
    - User
      - Login
        - __snapshots__ï¼šå¤šä½™å¯åˆ é™¤
        - login.test.tsxï¼šå¤šä½™å¯åˆ é™¤
    - TableListï¼šæš‚æ—¶æœªç”¨åˆ°ï¼Œåˆ é™¤
  - services
    - ant-design-proï¼šæœ‰å¾ˆå¤šæ¡†æ¶è‡ªå®šä¹‰çš„å‡½æ•°å’Œç±»å‹ï¼Œä¸ç”¨åˆ ï¼Œå¯èƒ½ä¼šå¼•èµ·è¿é”æ•ˆåº”
    - luobiï¼šæˆ‘ä»¬è‡ªå·±ä½¿ç”¨openapiç”Ÿæˆçš„å‡½æ•°å’Œç±»å‹
    - swaggerï¼šæ— ç”¨å¯åˆ é™¤
  - access.tsï¼šæ§åˆ¶é¡µé¢è®¿é—®
  - app.tsxï¼šæ•´ä¸ªæ¡†æ¶çš„å…¥å£æ–‡ä»¶
  - global.lessï¼šå…¨å±€æ ·å¼
  - global.tsxï¼šå…¨å±€çš„jsæ–‡ä»¶ï¼Œä¸è¦åˆ æ”¹
  - manifest.jsonï¼šå¼€å‘appæˆ–H5ç½‘é¡µæ—¶æŒ‡å®šçš„é…ç½®ï¼šæ¯”å¦‚å£°æ˜é¡¹ç›®çš„åç§°ï¼Œå›¾æ ‡çš„å°ºå¯¸ï¼Œæ‰“åŒ…æ—¶ç”¨ã€‚å¯åˆ 
  - requestErrorConfigï¼šå‰ç«¯å‘è¯·æ±‚çš„ä¸€äº›é…ç½®ï¼Œæ¯”å¦‚è¯·æ±‚å“åº”æ‹¦æˆªå™¨ï¼Œè¯·æ±‚å‰ç¼€
  - service-workers.jsï¼šä¸ºäº†ä¼˜åŒ–ç¦»çº¿H5é¡µé¢çš„ä½“éªŒ
  - typings.d.tsï¼šä¸çŸ¥é“ï¼Œä¸èƒ½åˆ 
- testsï¼šæµ‹è¯•æ–‡ä»¶ï¼Œæ— ç”¨å¯åˆ é™¤
- typesï¼šæ— ç”¨å¯åˆ é™¤
- .editorconfigã€.eslintrc.jsã€.prettierrc.jsï¼šç”¨æ¥ä¿è¯å‰ç«¯ä»£ç è§„èŒƒ
- jest.config.tsï¼šå•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œä¸ç”¨UIæµ‹è¯•å¯åˆ é™¤
- jsconfig.jsonï¼šæ§åˆ¶ä»£ç è¯­æ³•
- README.mdï¼šé¡¹ç›®çš„ä»‹ç»æ–‡æ¡£

#### æ›¿æ¢logo

**favicon.icoï¼š**ç½‘ç«™å·¦ä¸Šè§’å°å›¾æ ‡ https://www.iconfont.cn

![image-20231031205626497](assets/image-20231031205626497.png)

![image-20231031205828170](assets/image-20231031205828170.png)

png è½¬favicon https://www.gaituba.com/favicon

![image-20231031210026473](assets/image-20231031210026473.png)

**logo.svgï¼š**æ›¿æ¢æˆè‡ªå·±çš„logohttps://www.iconfont.cn

![image-20231031205304201](assets/image-20231031205304201.png)

![image-20231031205328579](assets/image-20231031205328579.png)

![image-20231031210249195](assets/image-20231031210249195.png)

#### prettierç¾åŒ–é…ç½®

![image-20231031212517690](assets/image-20231031212517690.png)

#### æ›¿æ¢ç½‘ç«™æ ‡é¢˜

å…¨å±€æ›¿æ¢ Ant Design Pro å’Œ Ant Design

![image-20231031213130067](assets/image-20231031213130067.png)

![image-20231031213338025](assets/image-20231031213338025.png)

#### æ›¿æ¢åº•éƒ¨çš„ç‰ˆæƒä¿¡æ¯

ç›´æ¥æœç´¢åº•éƒ¨å…³é”®å­—ï¼Œå»å¯¹åº”æ–‡ä»¶ä¿®æ”¹

![image-20231031214414293](assets/image-20231031214414293.png)

### åç«¯

1. ä½¿ç”¨åç«¯é¡¹ç›®æ¨¡æ¿

å¤åˆ¶æ¨¡æ¿ï¼Œä¿®æ”¹ç›®å½•åä¸ºé¡¹ç›®å

2. è¿æ¥æ•°æ®åº“

   ![image-20231031113006757](assets/image-20231031113006757.png)

3. ä¿®æ”¹æ•°æ®åº“å

![image-20231031113312177](assets/image-20231031113312177.png)

4. ä¿®æ”¹é¡¹ç›®å

![image-20231031113526512](assets/image-20231031113526512.png)

![image-20231031113636977](assets/image-20231031113636977.png)

5. å¼€å¯åˆ†å¸ƒå¼session

![image-20231031114027856](assets/image-20231031114027856.png)

![image-20231031114048256](assets/image-20231031114048256.png)

6. ä¿®æ”¹ç«¯å£

![image-20231031114227436](assets/image-20231031114227436.png)

7. å¯åŠ¨å¹¶è®¿é—®æ¥å£æ–‡æ¡£

![image-20231031114401762](assets/image-20231031114401762.png)

## åç«¯

### æ•°æ®åº“è¡¨è®¾è®¡

**ç”¨æˆ·è¡¨ï¼š**

```sql
create table if not exists user
(
    id           bigint auto_increment comment 'id' primary key,
    userAccount  varchar(256)                           not null comment 'è´¦å·',
    userPassword varchar(512)                           not null comment 'å¯†ç ',
    userName     varchar(256)                           null comment 'ç”¨æˆ·æ˜µç§°',
    userAvatar   varchar(1024)                          null comment 'ç”¨æˆ·å¤´åƒ',
    userProfile  varchar(512)                           null comment 'ç”¨æˆ·ç®€ä»‹',
    userRole     varchar(256) default 'user'            not null comment 'ç”¨æˆ·è§’è‰²ï¼šuser/admin/ban',
    gender       tinyint                                null comment 'æ€§åˆ«',
    createTime   datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete     tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    index idx_userAccount (userAccount)
) comment 'ç”¨æˆ·' collate = utf8mb4_unicode_ci;
```

**å›¾è¡¨ä¿¡æ¯è¡¨ï¼š**

```sql
create table if not exists chart
(
    id          bigint auto_increment comment 'id' primary key,
    goal        text                                   null comment 'åˆ†æç›®æ ‡',
    rawData     text                                   null comment 'åŸå§‹æ•°æ®',
    chartType   varchar(128)                           null comment 'å›¾è¡¨ç±»å‹',
    chartName   varchar(128)                           null comment 'å›¾è¡¨åç§°',
    genChart    text                                   null comment 'AIç”Ÿæˆçš„å›¾è¡¨æ•°æ®',
    genSummary  text                                   null comment 'AIç”Ÿæˆçš„åˆ†ææ€»ç»“',
    userId      bigint                                 null comment 'åˆ›å»ºäººid',
    status      varchar(128) default 'wait'            not null comment 'wait,succeeded,failed,running',
    execMessage text                                   null comment 'æ‰§è¡Œä¿¡æ¯',
    createTime  datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime  datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete    tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤'
) comment 'å›¾è¡¨ä¿¡æ¯' collate = utf8mb4_unicode_ci;
```

### è‡ªåŠ¨ç”Ÿæˆå¢åˆ æ”¹æŸ¥ä»£ç 

![image-20231031141404931](assets/image-20231031141404931.png)

![image-20231031141439155](assets/image-20231031141439155.png)

![image-20231031141503920](assets/image-20231031141503920.png)

1. ç”Ÿæˆçš„UserServiceå’ŒUserServiceImplä¸ç”¨æ›¿æ¢åŸæ¥çš„

2. ä¿®æ”¹å­—æ®µçš„æ³¨è§£

   ![image-20231031142728852](assets/image-20231031142728852.png)

   ![image-20231031142744734](assets/image-20231031142744734.png)

   ![image-20231031142801435](assets/image-20231031142801435.png)

   ![image-20231031142813281](assets/image-20231031142813281.png)

3. åˆ æ‰UserServiceå’ŒUserServiceImplå’ŒUserControllerä¸­ç”¨ä¸åˆ°çš„æ–¹æ³•

   ![image-20231031143327862](assets/image-20231031143327862.png)

   ![image-20231031143356282](assets/image-20231031143356282.png)

   ![image-20231031143538773](assets/image-20231031143538773.png)

4. åˆ æ‰å¾®ä¿¡å…¬ä¼—å·å¼€å‘åŒ…

   ![image-20231031143643260](assets/image-20231031143643260.png)

5. åˆ æ‰WxMPController

   ![image-20231031143826847](assets/image-20231031143826847.png)

### å›¾è¡¨ç®¡ç†

1. å¤åˆ¶PostControllerä¿®æ”¹æˆChartController

   ![image-20231031145120748](assets/image-20231031145120748.png)

   ![image-20231031145230166](assets/image-20231031145230166.png)

   ![image-20231031145445986](assets/image-20231031145445986.png)  

2. åˆ›å»ºå…³äºChartçš„DTOç±»

   ![image-20231031153057014](assets/image-20231031153057014.png)

3. å‰ªè£ChartControllerå¹¶ä¸ºChartServiceæä¾›getQueryWrapperæ–¹æ³•

   ```java
   /**
    * @author è½æ¨±çš„æ‚”æ¨
    * @description é’ˆå¯¹è¡¨ã€chart(å›¾è¡¨ä¿¡æ¯è¡¨)ã€‘çš„æ•°æ®åº“æ“ä½œServiceå®ç°
    * @createDate 2023-10-31 14:16:29
    */
   @Service
   public class ChartServiceImpl extends ServiceImpl<ChartMapper, Chart>
           implements ChartService {
   
       /**
        * è·å–æŸ¥è¯¢åŒ…è£…ç±»
        *
        * @param chartQueryRequest
        * @return
        */
       @Override
       public QueryWrapper<Chart> getQueryWrapper(ChartQueryRequest chartQueryRequest) {
           QueryWrapper<Chart> queryWrapper = new QueryWrapper<>();
           if (chartQueryRequest == null) {
               return queryWrapper;
           }
           Long id = chartQueryRequest.getId();
           Long userId = chartQueryRequest.getUserId();
           String goal = chartQueryRequest.getGoal();
           String chartType = chartQueryRequest.getChartType();
           String chartName = chartQueryRequest.getChartName();
           String sortField = chartQueryRequest.getSortField();
           String sortOrder = chartQueryRequest.getSortOrder();
           // æ‹¼æ¥æŸ¥è¯¢æ¡ä»¶
           queryWrapper.eq(id != null && id > 0, "id", id);
           queryWrapper.eq(ObjectUtils.isNotEmpty(userId), "userId", userId);
           queryWrapper.like(StringUtils.isNotBlank(goal), "goal", goal);
           queryWrapper.like(StringUtils.isNotBlank(chartType), "chartType", chartType);
           queryWrapper.like(StringUtils.isNotBlank(chartName), "chartName", chartName);
           queryWrapper.eq("isDelete", false);
           queryWrapper.orderBy(SqlUtils.validSortField(sortField), sortOrder.equals(CommonConstant.SORT_ORDER_ASC),
                   sortField);
           return queryWrapper;
       }
   }
   ```


### æ™ºèƒ½å›¾è¡¨åˆ†æ

#### **AIè°ƒç”¨çš„å‡ ç§æ–¹å¼**

**1ã€ç›´æ¥è°ƒç”¨ OpenAI æˆ–è€…å…¶ä»– AI åŸå§‹å¤§æ¨¡å‹å®˜ç½‘çš„æ¥å£**

å®˜æ–¹æ–‡æ¡£ï¼šhttps://platform.openai.com/docs/api-reference

ä¼˜ç‚¹ï¼šä¸ç»å°è£…ï¼Œæœ€çµæ´»ï¼Œæœ€åŸå§‹

ç¼ºç‚¹ï¼šè¦é’±

ä½¿ç”¨æ–¹å¼ï¼š

1ï¼‰åœ¨è¯·æ±‚å¤´ä¸­æŒ‡å®šOPENAI_API_KEY

```
Authorization: Bearer OPENAI_API_KEY
```

2ï¼‰æ‰¾åˆ°è¦ä½¿ç”¨çš„æ¥å£ https://platform.openai.com/docs/api-reference/chat/create

3ï¼‰æŒ‰ç…§æ¥å£æ–‡æ¡£çš„ç¤ºä¾‹ï¼Œæ„é€  HTTP è¯·æ±‚

```
curl https://api.openai.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -d '{
    "model": "gpt-3.5-turbo",
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful assistant."
      },
      {
        "role": "user",
        "content": "Hello!"
      }
    ]
  }'

```

```java
import cn.hutool.http.HttpRequest;
import cn.hutool.json.JSONUtil;

import java.util.*;

public class OpenAIAPI {
    public static void main(String[] args) {
        String url = "https://api.openai.com/v1/chat/completions";

        LinkedHashMap<String,Object> map =new LinkedHashMap<>();
        List<LinkedHashMap<String,Object>> messageList =new ArrayList<>();

        LinkedHashMap<String,Object> messageMap =new LinkedHashMap<>();
        messageMap.put("role","system");
        messageMap.put("content","You are a helpful assistant.");

        messageList.add(messageMap);

        map.put("model","gpt-3.5-turbo");
        map.put("message",messageList);

        String requestBody = JSONUtil.toJsonStr(map);
        HttpRequest.post(url)
                .header("Authorization","Bearer OPENAI_API_KEY")
                .header("Content-Type","application/json")
                .body(requestBody)
                .execute()
                .body();
    }
}
```

![image-20231102104638957](assets/image-20231102104638957.png)

**2ã€ä½¿ç”¨äº‘æœåŠ¡å•†æä¾›çš„ï¼Œå°è£…åçš„ AI æ¥å£**

æ¯”å¦‚ï¼šAzureäº‘

ä¼˜ç‚¹ï¼šæœ¬åœ°èƒ½ç”¨

ç¼ºç‚¹ï¼šè¦é’±

**3ã€åˆ©ç”¨é±¼èªæ˜ AI æä¾›çš„å¼€æ”¾ SDK** https://github.com/liyupi/yucongming-java-sdk

ä¼˜ç‚¹ï¼šç›®å‰ä¸è¦é’±ï¼Œæœ‰å¾ˆå¤šç°æˆçš„æ¨¡å‹

ç¼ºç‚¹ï¼šä¸å¤Ÿçµæ´»

1ï¼‰å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.yucongming</groupId>
    <artifactId>yucongming-java-sdk</artifactId>
    <version>0.0.3</version>
</dependency>
```

2ï¼‰ä¿®æ”¹é…ç½®

```yml
yuapi:
  client:
    access-key: c34re67to6v7yu2qf4nzawr8ultmy0a2
    secret-key: i6cnztxw6scfmrtykndjd5apitqcrejv
```

3ï¼‰è°ƒç”¨æ¥å£

```java
@Component
public class AIManager {
    @Resource
    private YuCongMingClient yuCongMingClient;

    /**
     *
     * @param modelId
     * @param message
     * @return
     */
    public String doChat(long modelId,String message){
        DevChatRequest devChatRequest = new DevChatRequest();
        devChatRequest.setModelId(modelId);
        devChatRequest.setMessage(message);
        BaseResponse<DevChatResponse> response = yuCongMingClient.doChat(devChatRequest);
        if (response==null){
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"AIå“åº”é”™è¯¯");
        }
        return response.getData().getContent();
    }
}
```

#### ä¸šåŠ¡æµç¨‹

1. æ ¡éªŒå‚æ•°
2. å‹ç¼©åŸå§‹æ•°æ®ï¼šAIæ¥å£æ™®ééƒ½æœ‰è¾“å…¥å­—æ•°é™åˆ¶ï¼Œå°½å¯èƒ½å‹ç¼©æ•°æ®ï¼Œèƒ½å¤Ÿå¤šä¼ ä¸€äº›æ•°æ®
3. æ„é€ ç”¨æˆ·è¯·æ±‚ï¼ˆåˆ†æç›®æ ‡ï¼Œå›¾è¡¨åç§°ï¼Œå›¾è¡¨ç±»å‹ï¼Œcsvæ•°æ®ï¼‰
4. è°ƒç”¨é±¼èªæ˜SDKï¼Œå¾—åˆ°å“åº”ï¼ˆå›¾è¡¨ä¿¡æ¯ï¼Œç»“è®ºæ–‡æœ¬ï¼‰
5. ä»AIå“åº”ç»“æœä¸­ï¼Œå–å‡ºéœ€è¦çš„æ•°æ®ï¼ˆå›¾è¡¨ä¿¡æ¯ï¼šEcharts V5 çš„ options é…ç½®å¯¹è±¡jsä»£ç ï¼›ç»“è®ºæ–‡æœ¬ï¼‰
6. ä¿å­˜åˆ°æ•°æ®åº“
7. è¿”å›å›¾è¡¨ä¿¡æ¯ï¼Œç»“è®ºæ–‡æœ¬ï¼Œå›¾è¡¨IDç»™å‰ç«¯

**æ¨¡å‹é¢„è®¾**

```
ä½ æ˜¯ä¸€ä¸ªæ•°æ®åˆ†æå¸ˆå’Œå‰ç«¯å¼€å‘ä¸“å®¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šæŒ‰ç…§ä»¥ä¸‹å›ºå®šæ ¼å¼ç»™ä½ æä¾›å†…å®¹ï¼š
åˆ†æéœ€æ±‚ï¼š
{æ•°æ®åˆ†æçš„éœ€æ±‚æˆ–è€…ç›®æ ‡}
åŸå§‹æ•°æ®ï¼š
{csvæ ¼å¼çš„åŸå§‹æ•°æ®ï¼Œç”¨,ä½œä¸ºåˆ†éš”ç¬¦}
è¯·æ ¹æ®è¿™ä¸¤éƒ¨åˆ†å†…å®¹ï¼ŒæŒ‰ç…§ä»¥ä¸‹æŒ‡å®šæ ¼å¼ç”Ÿæˆå†…å®¹ï¼ˆæ­¤å¤–ä¸è¦è¾“å‡ºä»»ä½•å¤šä½™çš„å¼€å¤´ã€ç»“å°¾ã€æ³¨é‡Šï¼‰
ã€ã€ã€ã€ã€
{å‰ç«¯ Echarts V5 çš„ option é…ç½®å¯¹è±¡jsonä»£ç ï¼Œåˆç†åœ°å°†æ•°æ®è¿›è¡Œå¯è§†åŒ–ï¼Œä¸è¦ç”Ÿæˆä»»ä½•å¤šä½™çš„å†…å®¹ï¼Œæ¯”å¦‚æ³¨é‡Š}
ã€ã€ã€ã€ã€
{æ˜ç¡®çš„æ•°æ®åˆ†æç»“è®ºã€è¶Šè¯¦ç»†è¶Šå¥½ï¼Œä¸è¦ç”Ÿæˆå¤šä½™çš„æ³¨é‡Š}
```

![image-20231102134925868](assets/image-20231102134925868.png)

```java
@Data
public class GenChartRequest implements Serializable {

    /**
     * åˆ†æç›®æ ‡
     */
    private String goal;

    /**
     * å›¾è¡¨ç±»å‹
     */
    private String chartType;

    /**
     * å›¾è¡¨åç§°
     */
    private String chartName;

    private static final long serialVersionUID = 1L;
}
```

```java
/**
 * BIçš„è¿”å›ç»“æœ
 */
@Data
public class BIResponse {
    private String genChart;

    private String genSummary;

    private Long chartId;
}
```

```java
@Slf4j
public class ExcelUtils {
    public static String excelToCsv(MultipartFile multipartFile) {
        /*File file = null;
        try {
            file = ResourceUtils.getFile("classpath:ç½‘ç«™æ•°æ®.xlsx");
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }*/
        // 1. ä»æ–‡ä»¶è¯»å–å‡ºæ•°æ®
        List<Map<Integer, String>> list = null;
        try {
            list = EasyExcel.read(multipartFile.getInputStream())
                    .excelType(ExcelTypeEnum.XLSX)
                    .sheet()
                    .headRowNumber(0)
                    .doReadSync();
        } catch (IOException e) {
            log.error("è¡¨æ ¼å¤„ç†é”™è¯¯",e);
        }
        if (CollectionUtil.isEmpty(list)) {
            return "";
        }
        // 2. è½¬æ¢ä¸ºcsv
        StringBuilder stringBuilder = new StringBuilder();
        // 2.1 è¯»å–è¡¨å¤´
        LinkedHashMap<Integer, String> headerMap = (LinkedHashMap) list.get(0);
        List<String> headerList =headerMap.values().stream().filter(ObjectUtils::isNotEmpty).collect(Collectors.toList());
        stringBuilder.append(StringUtils.join(headerList, ",")).append("\n");
        // 2.1 è¯»å–æ•°æ®è¡Œ
        for (int i = 1; i < list.size(); i++) {
            LinkedHashMap<Integer, String> dataMap = (LinkedHashMap) list.get(i);
            List<String> dataList = dataMap.values().stream().filter(ObjectUtils::isNotEmpty).collect(Collectors.toList());
            stringBuilder.append(StringUtils.join(dataList, ",")).append("\n");
        }
        return stringBuilder.toString();
    }
}
```

```java
@Service
public class AIManager {
    @Resource
    private YuCongMingClient yuCongMingClient;

    /**
     *
     * @param modelId
     * @param message
     * @return
     */
    public String doChat(long modelId,String message){
        DevChatRequest devChatRequest = new DevChatRequest();
        devChatRequest.setModelId(modelId);
        devChatRequest.setMessage(message);
        BaseResponse<DevChatResponse> response = yuCongMingClient.doChat(devChatRequest);
        if (response==null){
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"AIå“åº”é”™è¯¯");
        }
        return response.getData().getContent();
    }
}
```

```java
/**
 * æ™ºèƒ½åˆ†æ
 *
 * @param multipartFile
 * @param genChartRequest
 * @param request
 * @return
 */
@PostMapping("/gen")
public BaseResponse<BIResponse> genChartByAI(@RequestPart("file") MultipartFile multipartFile,
                                             GenChartRequest genChartRequest, HttpServletRequest request) {
    String goal = genChartRequest.getGoal();
    String chartType = genChartRequest.getChartType();
    String chartName = genChartRequest.getChartName();
    // æ‹¼æ¥åˆ†æç›®æ ‡
    if (StringUtils.isNotBlank(chartType)) {
        goal = goal + "ï¼Œè¯·ä½¿ç”¨" + chartType;
    }
    // æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(StringUtils.isBlank(goal), ErrorCode.PARAMS_ERROR, "åˆ†æç›®æ ‡ä¸ºç©º");
    ThrowUtils.throwIf(StringUtils.isNotBlank(chartName) && chartName.length() > 128, ErrorCode.PARAMS_ERROR, "å›¾è¡¨åç§°è¿‡é•¿");
    // è·å–ç™»å½•ç”¨æˆ·
    User loginUser = userService.getLoginUser(request);
    // å‹ç¼©åŸå§‹æ•°æ®
    String data = ExcelUtils.excelToCsv(multipartFile);
    // æ„é€ ç”¨æˆ·è¯·æ±‚ï¼ˆåˆ†æç›®æ ‡ï¼Œå›¾è¡¨åç§°ï¼Œå›¾è¡¨ç±»å‹ï¼Œcsvæ•°æ®ï¼‰
    StringBuilder userInput = new StringBuilder();
    userInput.append("åˆ†æéœ€æ±‚ï¼š").append("\n");
    userInput.append(goal).append("\n");
    userInput.append("åŸå§‹æ•°æ®ï¼š").append("\n");
    userInput.append(data).append("\n");
    // è°ƒç”¨é±¼èªæ˜SDKï¼Œå¾—åˆ°å“åº”
    long biModelId = 1719916921023344642L;
    String answer = aiManager.doChat(biModelId, userInput.toString());
    // ä»AIå“åº”ç»“æœä¸­ï¼Œå–å‡ºéœ€è¦çš„æ•°æ®
    String[] splits = answer.split("ã€ã€ã€ã€ã€");
    if (splits.length < 3) {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "AIç”Ÿæˆé”™è¯¯");
    }
    String genChart = splits[1].trim();
    String genSummary = splits[2].trim();
    // æ’å…¥æ•°æ®åº“
    Chart chart = new Chart();
    chart.setGoal(goal);
    chart.setRawData(data);
    chart.setChartType(chartType);
    chart.setChartName(chartName);
    chart.setGenChart(genChart);
    chart.setGenSummary(genSummary);
    chart.setUserId(loginUser.getId());
    boolean save = chartService.save(chart);
    ThrowUtils.throwIf(!save, ErrorCode.SYSTEM_ERROR, "å›¾è¡¨ä¿å­˜å¤±è´¥");
    // è¿”å›ç»™å‰ç«¯
    BIResponse biResponse = new BIResponse();
    biResponse.setGenChart(genChart);
    biResponse.setGenSummary(genSummary);
    biResponse.setChartId(chart.getId());
    return ResultUtils.success(biResponse);
}
```

![image-20231102135109277](assets/image-20231102135109277.png)

### ç³»ç»Ÿä¼˜åŒ–

#### å®‰å…¨æ€§

**é—®é¢˜ï¼š**å¦‚æœç”¨æˆ·ä¸Šä¼ ä¸€ä¸ªè¶…å¤§çš„æ–‡ä»¶æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚1000G

**è§£å†³ï¼š**åªè¦æ¶‰åŠåˆ°ç”¨æˆ·è‡ªä¸»ä¸Šä¼ çš„æ“ä½œï¼Œä¸€å®šè¦æ ¡éªŒæ–‡ä»¶

- æ–‡ä»¶çš„å¤§å°
- æ–‡ä»¶çš„åç¼€
- æ–‡ä»¶çš„å†…å®¹ï¼ˆæˆæœ¬é«˜ä¸€äº›ï¼‰
- æ–‡ä»¶çš„åˆæ³•æ€§ï¼ˆä¸èƒ½æœ‰æ•æ„Ÿçš„å†…å®¹ï¼Œå»ºè®®ç”¨ç¬¬ä¸‰æ–¹çš„å®¡æ ¸åŠŸèƒ½ï¼Œä¸è¦è‡ªå·±å†™ï¼‰

```java
// æ ¡éªŒæ–‡ä»¶
long size = multipartFile.getSize();
String originalFilename = multipartFile.getOriginalFilename();
// æ ¡éªŒæ–‡ä»¶å¤§å°
final long ONE_MB = 1024 * 1024L;
ThrowUtils.throwIf(size > ONE_MB, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°è¶…è¿‡ 1M");
// æ ¡éªŒæ–‡ä»¶åç¼€
String suffix = FileUtil.getSuffix(originalFilename);
final List<String> validFileSuffix = Arrays.asList("xlsx");
ThrowUtils.throwIf(!validFileSuffix.contains(suffix), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶åç¼€ä¸ç¬¦åˆè¦æ±‚");
```

**æ‰©å±•ç‚¹ï¼š**

æ¥å…¥è…¾è®¯äº‘çš„å›¾ç‰‡ä¸‡è±¡æ•°æ®å®¡æ ¸ï¼ˆCOSå¯¹è±¡å­˜å‚¨çš„å®¡æ ¸åŠŸèƒ½ï¼‰



#### æ•°æ®å­˜å‚¨

**ç°çŠ¶ï¼š**æˆ‘ä»¬æŠŠæ¯ä¸ªå›¾è¡¨çš„åŸå§‹æ•°æ®å­˜æ”¾åœ¨äº†åŒä¸€ä¸ªæ•°æ®è¡¨ï¼ˆchartè¡¨ï¼‰çš„å­—æ®µé‡Œ

**é—®é¢˜ï¼š**

1. å¦‚æœç”¨æˆ·æ—¥ç›Šå¢å¤šï¼Œé‚£ä¹ˆå›¾è¡¨æ•°ä¹Ÿä¼šå¢å¤šï¼Œå†å¦‚æœç”¨æˆ·ä¸Šä¼ çš„å›¾è¡¨åŸå§‹æ•°æ®é‡å¾ˆå¤§ï¼Œå°±ä¼šé€ æˆå•è¡¨ä½“ç§¯å¾ˆå¤§ï¼ŒæŸ¥è¯¢ä¹Ÿä¼šå˜æ…¢
2. å¯¹äº BI å¹³å°ï¼Œç”¨æˆ·æ˜¯æœ‰æŸ¥çœ‹åŸå§‹æ•°æ®ï¼Œå¯¹åŸå§‹æ•°æ®è¿›è¡Œç®€å•æŸ¥è¯¢çš„éœ€æ±‚çš„ã€‚ç°åœ¨å¦‚æœæŠŠæ‰€æœ‰æ•°æ®å­˜æ”¾åœ¨ä¸€ä¸ªå­—æ®µä¸­ï¼ŒæŸ¥è¯¢æ—¶ï¼Œåªèƒ½å–è¿™ä¸ªå­—æ®µçš„æ‰€æœ‰æ•°æ®

**è§£å†³ï¼š**

1. æŠŠæ¯ä¸ªå›¾è¡¨å¯¹åº”çš„åŸå§‹æ•°æ®å•ç‹¬ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„æ•°æ®è¡¨ï¼Œè€Œä¸æ˜¯éƒ½å­˜åœ¨ä¸€ä¸ªå­—æ®µé‡Œ

![image-20231104095152123](assets/image-20231104095152123.png)

**å¥½å¤„ï¼š**

1. å­˜å‚¨æ—¶ï¼Œåˆ†å¼€å­˜å‚¨ï¼Œäº’ä¸å½±å“ï¼ˆä¹Ÿèƒ½å¢åŠ å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„ç”¨æˆ·ä¸Šä¼ å¤§æ–‡ä»¶ï¼Œå½±å“å…¶ä»–ç”¨æˆ·ä½“éªŒï¼‰
2. æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨sqlè¯­å¥çµæ´»å–å‡ºéœ€è¦çš„å­—æ®µï¼ŒæŸ¥è¯¢æ€§èƒ½æ›´å¿«

**å®ç°ï¼š**

åˆ†å¼€å­˜å‚¨ï¼š

1. å­˜å‚¨å›¾è¡¨ä¿¡æ¯æ—¶ï¼Œä¸æŠŠå›¾è¡¨æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªå­—æ®µï¼Œè€Œæ˜¯æ–°å»ºä¸€ä¸ª chart_{å›¾è¡¨id} çš„æ•°æ®è¡¨

é€šè¿‡å›¾è¡¨idï¼Œæ•°æ®åˆ—åï¼Œæ•°æ®ç±»å‹ç­‰å­—æ®µï¼Œç”Ÿæˆä»¥ä¸‹sqlè¯­å¥ï¼Œå¹¶ä¸”æ‰§è¡Œå³å¯

```sql
create table chart_1720380873253691394
(
    æ—¥æœŸ  varchar(128) null,
    ç”¨æˆ·æ•° int          null
);
```

åˆ†å¼€æŸ¥è¯¢ï¼š

1. ä»¥å‰ç›´æ¥æŸ¥è¯¢å›¾è¡¨ï¼Œå–chartDataå­—æ®µï¼›ç°åœ¨æ”¹ä¸ºè¯»å–chart_{å›¾è¡¨id}çš„æ•°æ®è¡¨

```sql
select * from chart_1720380873253691394
```

**å…·ä½“å®ç°ï¼šMybatisçš„åŠ¨æ€SQL**

1ã€æƒ³æ¸…æ¥šå“ªäº›æ˜¯éœ€è¦åŠ¨æ€æ›¿æ¢çš„ï¼Œæ¯”å¦‚æŸ¥è¯¢çš„æ•°æ®è¡¨åchart_1720380873253691394 

2ã€åœ¨mapper.xmlä¸­å®šä¹‰sqlè¯­å¥

è¯¥æ–¹å¼æœ€çµæ´»ï¼Œä½†éœ€è¦å°å¿ƒsqlæ³¨å…¥

```sql
<select id="queryChartData" parameterType="string" resultType="map">
    ${querySql}
</select>
```

3ã€åœ¨mapperç±»ä¸­æ·»åŠ æ–¹æ³•

```java
public interface ChartMapper extends BaseMapper<Chart> {
    List<Map<String, Object>> queryChartData(@Param("querySql") String querySql);
}
```

4ã€æµ‹è¯•è°ƒç”¨

```java
@SpringBootTest
class ChartMapperTest {
    @Resource
    private ChartMapper chartMapper;

    @Test
    void queryChartData() {
        long chartId = 1720380873253691394L;
        String querySql = String.format("select * from chart_%s", chartId);
        List<Map<String, Object>> resultData = chartMapper.queryChartData(querySql);
        System.out.println(resultData);

    }
}
```

5ã€ç»“æœ

![image-20231104103300734](assets/image-20231104103300734.png)

**åˆ†åº“åˆ†è¡¨ï¼š**

1. æ°´å¹³åˆ†è¡¨ ï¼ˆæ ¹æ®ä¸€å®šçš„è§„åˆ™ï¼ŒæŠŠä¸€å¼ è¡¨çš„æ•°æ®åˆ’åˆ†åˆ°ä¸åŒçš„ç‰©ç†å­˜å‚¨ä½ç½®ä¸Šï¼‰
2. å‚ç›´åˆ†åº“ ï¼ˆæ ¹æ®ä¸šåŠ¡ï¼Œæ¯”å¦‚è®¢å•æ•°æ®åº“ï¼Œå•†å“æ•°æ®åº“ï¼‰

#### é™æµ

**é—®é¢˜ï¼š**ä½¿ç”¨ç³»ç»Ÿæ˜¯éœ€è¦æ¶ˆè€—æˆæœ¬çš„ï¼Œç”¨æˆ·æœ‰å¯èƒ½ç–¯ç‹‚åˆ·é‡ï¼Œè®©ä½ ç ´äº§

**è§£å†³ï¼š**

1ã€é™åˆ¶ç”¨æˆ·è°ƒç”¨æ€»æ¬¡æ•°ï¼Œæ§åˆ¶æˆæœ¬

2ã€ç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…ç–¯ç‹‚ä½¿ç”¨ï¼Œå¯¼è‡´æœåŠ¡å™¨èµ„æºè¢«å æ»¡ï¼Œå…¶ä»–ç”¨æˆ·æ— æ³•ä½¿ç”¨ => é™æµï¼Œé™åˆ¶å•ä½æ—¶é—´å†…è¯·æ±‚æ•°

**æ€è€ƒé™æµé˜ˆå€¼ï¼š**

1. å‚è€ƒæ­£å¸¸ç”¨æˆ·çš„ä½¿ç”¨é¢‘ç‡ï¼Œæ¯”å¦‚å•ä¸ªç”¨æˆ·æ¯ç§’åªèƒ½è°ƒç”¨ä¸€æ¬¡

**é™æµçš„å‡ ç§ç®—æ³•ï¼š**[é¢è¯•å¿…å¤‡ï¼š4ç§ç»å…¸é™æµç®—æ³•è®²è§£ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6967742960540581918)

**1ã€å›ºå®šçª—å£é™æµ**

å•ä½æ—¶é—´å†…å…è®¸éƒ¨åˆ†æ“ä½œï¼šæ¯”å¦‚1å°æ—¶åªå…è®¸10ä¸ªç”¨æˆ·æ“ä½œ

ä¼˜ç‚¹ï¼šç®€å•

ç¼ºç‚¹ï¼šå¯èƒ½å‡ºç°æµé‡çªåˆºï¼Œæ¯”å¦‚å‰59åˆ†é’Ÿæ²¡æœ‰ä¸€ä¸ªæ“ä½œï¼Œç¬¬59åˆ†é’Ÿæ¥äº†10ä¸ªæ“ä½œï¼Œç¬¬1å°æ—¶01åˆ†é’Ÿæ¥äº†10ä¸ªæ“ä½œã€‚ç›¸å½“äº2åˆ†é’Ÿæ‰§è¡Œäº†20ä¸ªæ“ä½œï¼ŒæœåŠ¡å™¨å¯èƒ½æ‰¿å—ä¸ä½å°±å´©äº†

**2ã€æ»‘åŠ¨çª—å£é™æµ**

å•ä½æ—¶é—´å†…å…è®¸éƒ¨åˆ†æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ªå•ä½æ—¶é—´æ˜¯æ»‘åŠ¨çš„ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªæ»‘åŠ¨å•ä½ï¼Œå³å¤šå°‘å•ä½æ—¶é—´æ»‘åŠ¨ä¸€æ¬¡

æ¯”å¦‚æ»‘åŠ¨å•ä½ï¼š1min

0h      1h         2h

è¿‡äº†1min

1min  - 1h1min

ä¼˜ç‚¹ï¼šèƒ½å¤Ÿè§£å†³ä¸Šè¿°æµé‡çªåˆºé—®é¢˜ï¼Œå› ä¸ºç¬¬59åˆ†é’Ÿæ—¶ï¼Œé™æµçª—å£æ˜¯59åˆ† -  1å°æ—¶59åˆ†ï¼Œè¿™ä¸ªçª—å£å†…åªèƒ½æ¥å—10æ¬¡è¯·æ±‚ï¼Œåªè¦è¿˜åœ¨è¿™ä¸ªçª—å£å†…ï¼Œæ›´å¤šçš„æ“ä½œå°±ä¼šè¢«æ‹’ç»

ç¼ºç‚¹ï¼šå®ç°ç›¸å¯¹å¤æ‚ï¼Œé™æµæ•ˆæœå’Œæ»‘åŠ¨å•ä½æœ‰å…³ï¼Œæ»‘åŠ¨å•ä½è¶Šå°ï¼Œé™æµæ•ˆæœè¶Šå¥½ï¼Œä½†å¾€å¾€å¾ˆéš¾é€‰å–åˆ°ä¸€ä¸ªåˆé€‚çš„æ»‘åŠ¨å•ä½

**3ã€æ¼æ¡¶é™æµ**ï¼ˆæ¨èï¼‰

ä»¥å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œå½“è¯·æ±‚é€šæ»¡äº†ï¼Œæ‹’ç»è¯·æ±‚

å‡è®¾æ¡¶çš„å®¹é‡æ˜¯10ï¼Œæ¯ç§’èƒ½å¤„ç†10ä¸ªè¯·æ±‚ï¼Œæ¯0.1ç§’å›ºå®šå¤„ç†ä¸€æ¬¡è¯·æ±‚ï¼Œå¦‚æœ1ç§’å†…æ¥äº†10ä¸ªè¯·æ±‚ï¼Œå¯ä»¥å¤„ç†å®Œã€‚ä½†1ç§’å†…æ¥äº†11ä¸ªè¯·æ±‚ï¼Œæœ€åå“ªä¸ªè¯·æ±‚ä¼šæº¢å‡ºæ¡¶ï¼Œè¢«æ‹’ç»

ä¼˜ç‚¹ï¼šèƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šåº”å¯¹æµé‡çªåˆºï¼Œå›ºå®šé€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œä¿è¯æœåŠ¡å™¨çš„å®‰å…¨

ç¼ºç‚¹ï¼šæ²¡æœ‰åŠæ³•è¿…é€Ÿå¤„ç†	ä¸€æ‰¹è¯·æ±‚ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªæŒ‰é¡ºåºæ¥å¤„ç†

**4ã€ä»¤ç‰Œæ¡¶é™æµ**ï¼ˆæ¨èï¼‰

ç®¡ç†å‘˜ç”Ÿæˆä¸€æ‰¹ä»¤ç‰Œï¼Œæ¯ç§’ç”Ÿæˆ10ä¸ªä»¤ç‰Œï¼›ç”¨æˆ·æ“ä½œå‰ï¼Œå…ˆå»æ‹¿åˆ°ä¸€ä¸ªä»¤ç‰Œï¼Œæœ‰ä»¤ç‰Œçš„äººå°±æœ‰èµ„æ ¼æ‰§è¡Œæ“ä½œï¼Œèƒ½åŒæ—¶æ‰§è¡Œæ“ä½œã€‚æ‹¿ä¸åˆ°ä»¤ç‰Œå°±ç­‰ç€

ä¼˜ç‚¹ï¼šèƒ½å¤Ÿå¹¶å‘å¤„ç†åŒæ—¶çš„è¯·æ±‚

éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼šè¿˜æ˜¯å­˜åœ¨æ—¶é—´å•ä½é€‰å–é—®é¢˜

**é™æµç²’åº¦ï¼š**

1. é’ˆå¯¹æŸä¸ªæ–¹æ³•é™æµï¼Œå³å•ä½æ—¶é—´å†…æœ€å¤šå…è®¸åŒæ—¶ xx ä¸ªæ“ä½œä½¿ç”¨è¯¥æ–¹æ³•
2. é’ˆå¯¹æŸä¸ªç”¨æˆ·é™æµï¼Œå³å•ä½æ—¶é—´å†…æœ€å¤šæ‰§è¡Œ xx ä¸ªæ“ä½œ
3. é’ˆå¯¹æŸä¸ªç”¨æˆ·æŸä¸ªæ–¹æ³•é™æµï¼Œ

**é™æµå®ç°ï¼š**

**1ã€æœ¬åœ°é™æµï¼ˆå•æœºé™æµï¼‰**

ä¸€èˆ¬é€‚ç”¨äºåªæœ‰ä¸€ä¸ªæœåŠ¡å™¨çš„é¡¹ç›®ï¼ˆå•ä½“é¡¹ç›®ï¼‰ï¼Œå¦‚æœæœ‰å¤šå°æœåŠ¡å™¨ï¼Œä¼šå­˜åœ¨æœåŠ¡å™¨ä¹‹é—´ç»Ÿè®¡æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ¯”å¦‚è°ƒç”¨æ¬¡æ•°ä¸ä¸€è‡´

ç¬¬ä¸‰æ–¹åº“ï¼šGuava RateLimiter



**2ã€åˆ†å¸ƒå¼é™æµï¼ˆå¤šæœºé™æµï¼Œå¾®æœåŠ¡é¡¹ç›®ï¼‰**

1ã€æŠŠç”¨æˆ·ä½¿ç”¨é¢‘ç‡ç­‰æ•°æ®æ”¾åˆ°ä¸€ä¸ªé›†ä¸­å­˜å‚¨å»ç»Ÿè®¡ï¼Œæ¯”å¦‚ä½¿ç”¨Redisï¼Œè¿™æ ·æ— è®ºç”¨æˆ·è¯·æ±‚è½åˆ°å“ªå°æœåŠ¡å™¨ï¼Œéƒ½å·²é›†ä¸­å­˜å‚¨ä¸­çš„æ•°æ®ä¸ºå‡†(Redisson)

2ã€åœ¨ç½‘å…³é›†ä¸­è¿›è¡Œé™æµå’Œç»Ÿè®¡ï¼ˆSentinelï¼ŒSpring Cloud Gateway)

**Redissoné™æµå®ç°**     https://github.com/redisson/redisson#quick-start

Redissonå†…ç½®äº†ä¸€ä¸ªé™æµå·¥å…·ç±»ï¼Œå¯ä»¥å¸®åŠ©ä½ åˆ©ç”¨Redisæ¥å­˜å‚¨ï¼Œç»Ÿè®¡

1. å¼•å…¥ä¾èµ–

```xml
<dependency>
   <groupId>org.redisson</groupId>
   <artifactId>redisson</artifactId>
   <version>3.24.3</version>
</dependency>  
```

2. åˆ›å»ºå®¢æˆ·ç«¯

```java
@Configuration
@ConfigurationProperties(prefix = "spring.redis")
@Data
public class RedissonConfig {
    private Integer dataBase;
    private String host;
    private Integer port;
    private String password;

    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
                .setDatabase(dataBase)
                .setAddress("redis://"+host+":"+port)
                .setPassword(password);
        RedissonClient redisson = Redisson.create(config);
        return redisson;
    }
}
```

3. RedisLimiterManager

   ä»€ä¹ˆæ˜¯Manager?ä¸“é—¨æä¾›RedisLimiter é™æµåŸºç¡€æœåŠ¡çš„ï¼ˆæä¾›äº†é€šç”¨çš„èƒ½åŠ›ï¼‰

```java
@Service
public class RedisLimiterManager {
    @Resource
    private RedissonClient redissonClient;

    /**
     * é™æµæ“ä½œ
     * @param key åŒºåˆ†ä¸åŒçš„é™æµå™¨ï¼Œæ¯”å¦‚ä¸åŒçš„ç”¨æˆ·Idï¼Œåº”è¯¥åˆ†åˆ«ç»Ÿè®¡
     */
    public void doRateLimit(String key){
        RRateLimiter rateLimiter = redissonClient.getRateLimiter(key);
        rateLimiter.trySetRate(RateType.OVERALL,2, 1,RateIntervalUnit.SECONDS);
        //æ¯å½“ä¸€ä¸ªæ“ä½œæ¥äº†åï¼Œè¯·æ±‚ä¸€ä¸ªä»¤ç‰Œ
        boolean canOp = rateLimiter.tryAcquire(1);
        if(!canOp) {
            throw new BusinessException(ErrorCode.TOO_MANY_REQUEST);
        }
    }
}
```

çœ‹ä¸åˆ°æ–¹æ³•å‚æ•°æ€ä¹ˆåŠï¼Ÿ

![image-20231104114523283](assets/image-20231104114523283.png)

1ã€çœ‹æ–‡æ¡£

2ã€ä¸‹è½½æºç ï¼šç‚¹è¿›ä»»æ„ä¸€ä¸ªåŒ…çš„ä»£ç ï¼Œç‚¹å‡»download sourceä¸‹è½½

![image-20231104114723886](assets/image-20231104114723886.png)

4. æµ‹è¯•è°ƒç”¨

```java
@SpringBootTest
class RedisLimiterManagerTest {
    @Resource
    private RedisLimiterManager redisLimiterManager;

    @Test
    void doRateLimit() {
        String userId = "1";
        //ä¸€ç§’è¯·æ±‚5æ¬¡	
        for (int i = 0; i < 5; i++) {
            redisLimiterManager.doRateLimit(userId);
            System.out.println("æˆåŠŸ");
        }
    }
}
```

![image-20231104115544690](assets/image-20231104115544690.png)

```java
@SpringBootTest
class RedisLimiterManagerTest {
    @Resource
    private RedisLimiterManager redisLimiterManager;

    @Test
    void doRateLimit() throws InterruptedException {
        String userId = "1";
        for (int i = 0; i < 2; i++) {
            redisLimiterManager.doRateLimit(userId);
            System.out.println("æˆåŠŸ");
        }
        Thread.sleep(1000);
        for (int i = 0; i < 5; i++) {
            redisLimiterManager.doRateLimit(userId);
            System.out.println("æˆåŠŸ");
        }
    }
}
```

![image-20231104115915513](assets/image-20231104115915513.png)

5. åº”ç”¨

```java
// é™æµ,æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªé™æµå™¨
redisLimiterManager.doRateLimit("genChartByAI_"+loginUser.getId().toString());
```

#### å¼‚æ­¥åŒ–

**åº”ç”¨åœºæ™¯ï¼š**è°ƒç”¨çš„æœåŠ¡å¤„ç†èƒ½åŠ›æœ‰é™ï¼Œæˆ–è€…å¤„ç†æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå°±åº”è¯¥è€ƒè™‘å¼‚æ­¥åŒ–ã€‚

**é—®é¢˜åˆ†æï¼š**

1. ç”¨æˆ·ç­‰å¾…AIç”Ÿæˆçš„æ—¶é—´æœ‰ç‚¹é•¿
2. æœåŠ¡å™¨å¯èƒ½ä¼šæœ‰å¾ˆå¤šè¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯¼è‡´ç³»ç»Ÿèµ„æºç´§å¼ ï¼Œä¸¥é‡æ—¶å¯¼è‡´æœåŠ¡å™¨å®•æœºæˆ–è€…æ— æ³•å¤„ç†æ–°çš„è¯·æ±‚
3. ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆAIèƒ½åŠ›ï¼‰çš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œæ¯”å¦‚æ¯3ç§’å¤„ç†1ä¸ªè¯·æ±‚ï¼Œè¿‡å¤šçš„è¯·æ±‚ä¼šå¯¼è‡´AIå¤„ç†ä¸è¿‡æ¥ï¼Œä¸¥é‡æ—¶ AI å¯èƒ½ä¼šæ‹’ç»ä¸ºåå°ç³»ç»Ÿæä¾›æœåŠ¡

**å¼‚æ­¥ï¼š**ä¸ç”¨ç­‰ä¸€ä»¶äº‹åšå®Œï¼Œå°±å¯ä»¥åšå¦ä¸€ä»¶äº‹ã€‚ç­‰ç¬¬ä¸€ä»¶äº‹åšå®Œï¼Œå¯ä»¥æ”¶åˆ°ä¸€ä¸ªé€šçŸ¥ï¼Œå‘Šè¯‰ä½ è¿™ä»¶äº‹åšå®Œäº†ï¼Œä½ å¯ä»¥å†è¿›è¡Œåç»­å¤„ç†ã€‚

**ä¸šåŠ¡æµç¨‹åˆ†æï¼š**

1ã€æ ‡å‡†å¼‚æ­¥åŒ–çš„ä¸šåŠ¡æµç¨‹

1. å½“ç”¨æˆ·è¦è¿›è¡Œè€—æ—¶å¾ˆé•¿çš„æ“ä½œæ—¶ï¼Œç‚¹å‡»æäº¤åï¼Œä¸éœ€è¦åœ¨ç•Œé¢å¹²ç­‰ï¼Œè€Œæ˜¯åº”è¯¥æŠŠè¿™ä¸ªä»»åŠ¡ä¿å­˜åˆ°æ•°æ®åº“ï¼Œç„¶åæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­

2. æ·»åŠ ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—æ—¶ï¼Œä¼šæœ‰ä»¥ä¸‹æƒ…å†µ

   a.æœ‰ç©ºé—²çº¿ç¨‹ï¼Œç«‹åˆ»è¿›è¡Œè¯¥ä»»åŠ¡

   b.æ²¡æœ‰ç©ºé—²çº¿ç¨‹ä¸”ä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—

   c.æ²¡æœ‰ç©ºé—²çº¿ç¨‹ä¸”ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡

   â€‹	i . æ‹’ç»ä»»åŠ¡

   â€‹	ii . åœ¨æœ‰ç©ºé—²çº¿ç¨‹æˆ–è€…ç©ºé—²é˜Ÿåˆ—ä½ç½®æ—¶ï¼Œä»æ•°æ®åº“ä¸­æŠŠä»»åŠ¡æå‡ºï¼Œå†å»æ‰§è¡Œ

3. ç¨‹åºï¼ˆçº¿ç¨‹ï¼‰ä»ä»»åŠ¡é˜Ÿåˆ—å–å‡ºä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œæ¯å®Œæˆä¸€ä»¶äº‹æƒ…è¦ä¿®æ”¹ä¸€ä¸‹ä»»åŠ¡çš„çŠ¶æ€ã€‚

4. ç”¨æˆ·å¯ä»¥æŸ¥è¯¢ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæˆ–è€…åœ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶èƒ½å¤Ÿå¾—åˆ°é€šçŸ¥ï¼ˆå‘é‚®ä»¶ï¼Œç³»ç»Ÿæ¶ˆæ¯æç¤ºï¼ŒçŸ­ä¿¡ï¼‰ï¼Œä»è€Œä¼˜åŒ–ä½“éªŒ

5. å¦‚æœè¦æ‰§è¡Œçš„ä»»åŠ¡éå¸¸å¤æ‚ï¼ŒåŒ…å«å¾ˆå¤šç¯èŠ‚ï¼Œåœ¨æ¯ä¸€ä¸ªç¯èŠ‚å®Œæˆæ—¶ï¼Œè¦åœ¨ç¨‹åºï¼ˆæ•°æ®åº“ï¼‰è®°å½•ä¸€ä¸‹è¯¥ç¯èŠ‚çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä»è€Œç»™ç”¨æˆ·å±•ç¤ºä»»åŠ¡è¿›åº¦

2ã€æœ¬é¡¹ç›®å¼‚æ­¥åŒ–çš„ä¸šåŠ¡æµç¨‹

1. ç”¨æˆ·ç‚¹å‡»æ™ºèƒ½åˆ†æé¡µçš„æäº¤æŒ‰é’®ï¼Œå…ˆæŠŠå›¾è¡¨ç«‹åˆ»ä¿å­˜åˆ°æ•°æ®åº“ä¸­
2. ç”¨æˆ·å¯ä»¥åœ¨ä¸ªäººå›¾è¡¨é¡µé¢æŸ¥çœ‹æ‰€æœ‰å›¾è¡¨ï¼ˆå·²ç”Ÿæˆï¼Œç”Ÿæˆä¸­ï¼Œç”Ÿæˆå¤±è´¥ï¼‰çš„ä¿¡æ¯å’ŒçŠ¶æ€
3. ç”¨æˆ·å¯ä»¥ä¿®æ”¹ç”Ÿæˆå¤±è´¥çš„å›¾è¡¨ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»é‡æ–°ç”Ÿæˆ

**é—®é¢˜ï¼š**

1. ä»»åŠ¡é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡åº”è¯¥è®¾ç½®ä¸ºå¤šå°‘ï¼Ÿ
2. ç¨‹åºæ€ä¹ˆä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å»æ‰§è¡Œï¼Ÿ
3. ä»»åŠ¡é˜Ÿåˆ—çš„æµç¨‹æ€ä¹ˆå®ç°
4. æ€ä¹ˆä¿è¯ç¨‹åºæœ€å¤šåŒæ—¶æ‰§è¡Œxä¸ªä»»åŠ¡

##### **çº¿ç¨‹æ± **

`ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ`

1. çº¿ç¨‹çš„ç®¡ç†æ¯”è¾ƒå¤æ‚ï¼ˆæ¯”å¦‚ä»€ä¹ˆæ—¶å€™æ–°å¢çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™å‡å°‘ç©ºé—²çº¿ç¨‹ï¼‰
2. ä»»åŠ¡å­˜å–æ¯”è¾ƒå¤æ‚ï¼ˆä»€ä¹ˆæ—¶ä¾¯æ¯”è¾ƒå¤æ‚ï¼Œä»€ä¹ˆæ—¶å€™æ‹’ç»ä»»åŠ¡ï¼Œæ€ä¹ˆä¿è¯å„ä¸ªçº¿ç¨‹ä¸æŠ¢åˆ°ç”¨ä¸€ä¸ªä»»åŠ¡ï¼‰

`çº¿ç¨‹æ± ä½œç”¨ï¼š`å¸®åŠ©ä½ è½»æ¾ç®¡ç†çº¿ç¨‹ï¼Œåè°ƒä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹

`çº¿ç¨‹æ± å®ç°ï¼š`

1. åœ¨Springä¸­ï¼Œå¯ä»¥ç”¨ ThreadPoolTaskExecutor ï¼Œé…åˆ @Async æ³¨è§£æ¥å®ç°ï¼ˆä¸å¤ªå»ºè®®ï¼‰
2. åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨ JUC å¹¶å‘ç¼–ç¨‹åŒ…ä¸­çš„ ThreadPoolExecutor æ¥å®ç°éå¸¸çµæ´»åœ°è‡ªå®šä¹‰çº¿ç¨‹æ± 

`çº¿ç¨‹æ± å‚æ•°ï¼š`

```java
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler) 
```

corePoolSizeï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•° ï¼‰ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿåº”è¯¥èƒ½åŒæ—¶å·¥ä½œçš„çº¿ç¨‹æ•°ï¼ˆéšæ—¶å°±ç»ªçš„çŠ¶æ€ï¼‰
maximumPoolSizeï¼ˆæœ€å¤§çº¿ç¨‹æ•° ï¼‰ï¼šæé™æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ± æœ€å¤šæœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼Ÿ
keepAliveTimeï¼ˆç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼‰ï¼šéæ ¸å¿ƒçº¿ç¨‹åœ¨æ²¡æœ‰ä»»åŠ¡çš„æƒ…å†µä¸‹ï¼Œè¿‡å¤šä¹…è¦åˆ é™¤ï¼ˆç†è§£ä¸ºå¼€é™¤ä¸´æ—¶å·¥ï¼‰ï¼Œä»è€Œé‡Šæ”¾æ— ç”¨çš„çº¿ç¨‹èµ„æºã€‚
TimeUnit unitï¼ˆç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´çš„å•ä½ï¼‰ï¼šåˆ†é’Ÿã€ç§’
workQueueï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰ï¼šç”¨äºå­˜æ”¾ç»™çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—çš„é•¿åº¦ï¼ˆä¸€å®šè¦è®¾ç½®ï¼Œä¸è¦è¯´é˜Ÿåˆ—é•¿åº¦æ— é™ï¼Œå› ä¸ºä¹Ÿä¼šå ç”¨èµ„æºï¼‰
threadFactoryï¼ˆçº¿ç¨‹å·¥å‚ï¼‰ï¼šæ§åˆ¶æ¯ä¸ªçº¿ç¨‹çš„ç”Ÿæˆã€çº¿ç¨‹çš„å±æ€§ï¼ˆæ¯”å¦‚çº¿ç¨‹åï¼‰
RejectedExecutionHandlerï¼ˆæ‹’ç»ç­–ç•¥ï¼‰ï¼šä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬é‡‡å–ä»€ä¹ˆæªæ–½ï¼Œæ¯”å¦‚æŠ›å¼‚å¸¸ã€ä¸æŠ›å¼‚å¸¸ã€è‡ªå®šä¹‰ç­–ç•¥

èµ„æºéš”ç¦»ç­–ç•¥ï¼šæ¯”å¦‚é‡è¦çš„ä»»åŠ¡ï¼ˆVIP ä»»åŠ¡ï¼‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ™®é€šä»»åŠ¡ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¿è¯è¿™ä¸¤ä¸ªé˜Ÿåˆ—äº’ä¸å¹²æ‰°ã€‚

`çº¿ç¨‹æ± å·¥ä½œæœºåˆ¶`

1. åˆšå¼€å§‹æ²¡æœ‰ä»»ä½•çš„çº¿ç¨‹ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•çš„ä»»åŠ¡

![image-20231104144503719](assets/image-20231104144503719.png)

2. æ¥äº†ä¸€ä¸ªä»»åŠ¡ï¼Œå‘ç°æˆ‘ä»¬çš„å‘˜å·¥è¿˜æ²¡æœ‰è¾¾åˆ°æ­£å¼å‘˜å·¥æ•°ï¼ˆcorePoolSize = 2ï¼‰ï¼Œæ¥ä¸€ä¸ªå‘˜å·¥ç›´æ¥å¤„ç†è¿™ä¸ªä»»åŠ¡

![image-20231104144708541](assets/image-20231104144708541.png)

3. åˆæ¥äº†ä¸€ä¸ªä»»åŠ¡ï¼Œå‘ç°æˆ‘ä»¬çš„å‘˜å·¥è¿˜æ²¡æœ‰è¾¾åˆ°æ­£å¼å‘˜å·¥æ•°ï¼ˆcorePoolSize = 2ï¼‰ï¼Œå†æ¥ä¸€ä¸ªå‘˜å·¥ç›´æ¥å¤„ç†è¿™ä¸ªä»»åŠ¡

![image-20231104144914128](assets/image-20231104144914128.png)

4. åˆæ¥äº†ä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬æ­£å¼å‘˜å·¥æ•°å·²ç»æ»¡äº†ï¼ˆå½“å‰çº¿ç¨‹æ•° = corePoolSize = 2ï¼‰ï¼Œä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—ï¼ˆæœ€å¤§é•¿åº¦ workQueue.size = 2ï¼‰é‡Œç­‰å¾…ï¼Œè€Œä¸æ˜¯å†åŠ æ–°å‘˜å·¥ã€‚

![image-20231104145032949](assets/image-20231104145032949.png)

5. åˆæ¥äº†ä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼ˆå½“å‰çº¿ç¨‹æ•° > corePoolSize = 2ï¼Œå·²æœ‰ä»»åŠ¡æ•° = æœ€å¤§é•¿åº¦ workQueue.size = 2ï¼‰ï¼Œæ–°å¢çº¿ç¨‹ï¼ˆmaximumPoolSize = 4ï¼‰æ¥å¤„ç†æ–°ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä¸¢å¼ƒä»»åŠ¡

![image-20231104145154625](assets/image-20231104145154625.png)

6. å·²ç»åˆ°äº†ä»»åŠ¡ 7ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ã€ä¸´æ—¶å·¥ä¹Ÿæ‹›æ»¡äº†ï¼ˆå½“å‰çº¿ç¨‹æ•° = maximumPoolSize = 4ï¼Œå·²æœ‰ä»»åŠ¡æ•° = æœ€å¤§é•¿åº¦ workQueue.size = 2ï¼‰ï¼Œè°ƒç”¨ RejectedExecutionHandler æ‹’ç»ç­–ç•¥æ¥å¤„ç†å¤šä½™çš„ä»»åŠ¡ã€‚

![image-20231104145250349](assets/image-20231104145250349.png)

7. å¦‚æœå½“å‰çº¿ç¨‹æ•°è¶…è¿‡ corePoolSizeï¼ˆæ­£å¼å‘˜å·¥æ•°ï¼‰ï¼Œåˆæ²¡æœ‰æ–°çš„ä»»åŠ¡ç»™ä»–ï¼Œé‚£ä¹ˆç­‰ keepAliveTime æ—¶é—´è¾¾åˆ°åï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ªçº¿ç¨‹é‡Šæ”¾ã€‚

`çº¿ç¨‹æ± å‚æ•°å¦‚ä½•è®¾ç½®ï¼Ÿ`

ç»“åˆå®é™…æƒ…å†µï¼ˆå®é™…ä¸šåŠ¡åœºæ™¯å’Œç³»ç»Ÿèµ„æºï¼‰æ¥æµ‹è¯•è°ƒæ•´ï¼Œä¸æ–­ä¼˜åŒ–ã€‚ 

å›å½’åˆ°æˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œè¦è€ƒè™‘ç³»ç»Ÿæœ€è„†å¼±çš„ç¯èŠ‚ï¼ˆæœ¨æ¡¶æ•ˆåº”ï¼‰åœ¨å“ªï¼Ÿ

ç°æœ‰æ¡ä»¶ï¼šå‡è®¾AIèƒ½åŠ›çš„å¹¶å‘æ˜¯åªå…è®¸ 4 ä¸ªçº¿ç¨‹åŒæ—¶å»æ‰§è¡Œï¼Œåªå…è®¸20ä¸ªä»»åŠ¡æ’é˜Ÿ

corePoolSizeï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•° => æ­£å¼å‘˜å·¥æ•°ï¼‰ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¯ä»¥è®¾ç½®ä¸º 2 - 4 
maximumPoolSizeï¼šè®¾ç½®ä¸ºæé™æƒ…å†µï¼Œè®¾ç½®ä¸º <= 4
keepAliveTimeï¼ˆç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼‰ï¼šä¸€èˆ¬è®¾ç½®ä¸ºç§’çº§æˆ–è€…åˆ†é’Ÿçº§
TimeUnit unitï¼ˆç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´çš„å•ä½ï¼‰ï¼šåˆ†é’Ÿã€ç§’
workQueueï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰ï¼šç»“åˆå®é™…è¯·å†µå»è®¾ç½®ï¼Œå¯ä»¥è®¾ç½®ä¸º 20
threadFactoryï¼ˆçº¿ç¨‹å·¥å‚ï¼‰ï¼šæ§åˆ¶æ¯ä¸ªçº¿ç¨‹çš„ç”Ÿæˆã€çº¿ç¨‹çš„å±æ€§ï¼ˆæ¯”å¦‚çº¿ç¨‹åï¼‰
RejectedExecutionHandlerï¼ˆæ‹’ç»ç­–ç•¥ï¼‰ï¼šæŠ›å¼‚å¸¸ï¼Œæ ‡è®°æ•°æ®åº“çš„ä»»åŠ¡çŠ¶æ€ä¸º â€œä»»åŠ¡æ»¡äº†å·²æ‹’ç»â€

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»»åŠ¡åˆ†ä¸º IO å¯†é›†å‹å’Œè®¡ç®—å¯†é›†å‹ä¸¤ç§ã€‚
è®¡ç®—å¯†é›†å‹ï¼šåƒ CPUï¼Œæ¯”å¦‚éŸ³è§†é¢‘å¤„ç†ã€å›¾åƒå¤„ç†ã€æ•°å­¦è®¡ç®—ç­‰ï¼Œä¸€èˆ¬æ˜¯è®¾ç½® corePoolSize ä¸º CPU çš„æ ¸æ•° + 1ï¼ˆç©ºä½™çº¿ç¨‹ï¼‰ï¼Œå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½åˆ©ç”¨å¥½ CPU çš„æ¯ä¸ªæ ¸ï¼Œè€Œä¸”çº¿ç¨‹ä¹‹é—´ä¸ç”¨é¢‘ç¹åˆ‡æ¢ï¼ˆå‡å°‘æ‰“æ¶ã€å‡å°‘å¼€é”€ï¼‰
IO å¯†é›†å‹ï¼šåƒå¸¦å®½/å†…å­˜/ç¡¬ç›˜çš„è¯»å†™èµ„æºï¼ŒcorePoolSize å¯ä»¥è®¾ç½®å¤§ä¸€ç‚¹ï¼Œä¸€èˆ¬ç»éªŒå€¼æ˜¯ 2n å·¦å³ï¼Œä½†æ˜¯å»ºè®®ä»¥ IO çš„èƒ½åŠ›ä¸ºä¸»ã€‚

è€ƒè™‘å¯¼å…¥ç™¾ä¸‡æ•°æ®åˆ°æ•°æ®åº“ï¼Œå±äº IO å¯†é›†å‹ä»»åŠ¡ã€è¿˜æ˜¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Ÿ

`è‡ªå®šä¹‰çº¿ç¨‹æ± `

```java
@Configuration
public class ThreadPoolExecutorConfig {


    @Bean
    public ThreadPoolExecutor threadPoolExecutor() {
        ThreadFactory threadFactory = new ThreadFactory() {
            private int count = 1;

            @Override
            public Thread newThread(@NotNull Runnable r) {
                Thread thread = new Thread(r);
                thread.setName("çº¿ç¨‹" + count);
                count++;
                return thread;
            }
        };
        return new ThreadPoolExecutor(2, 4, 100, TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(4), threadFactory, new ThreadPoolExecutor.AbortPolicy());
    }
}
```

`æäº¤ä»»åŠ¡&æŸ¥çœ‹çº¿ç¨‹æ± ä¿¡æ¯`

```java
/**
 * ä»»åŠ¡é˜Ÿåˆ—æ¨¡æ‹Ÿ
 */
@RestController
@RequestMapping("/queue")
@Slf4j
@Profile({"dev","local"})
public class QueueController {
    @Resource
    private ThreadPoolExecutor threadPoolExecutor;
    
    //æäº¤ä»»åŠ¡
    @GetMapping("/add")
    public void add(String name) {
        CompletableFuture.runAsync(() -> {
            System.out.println("ä»»åŠ¡æ‰§è¡Œä¸­ï¼š" + name+",æ‰§è¡Œäººï¼š"+Thread.currentThread().getName());
            try {
                Thread.sleep(600000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, threadPoolExecutor);
    }
    
    //æŸ¥çœ‹çº¿ç¨‹æ± ä¿¡æ¯
    @GetMapping("/get")
    public Map<String, Object> get(){
        Map<String,Object> map = new HashMap<>();
        int size = threadPoolExecutor.getQueue().size();
        long taskCount = threadPoolExecutor.getTaskCount();
        long completedTaskCount = threadPoolExecutor.getCompletedTaskCount();
        long activeCount = threadPoolExecutor.getActiveCount();
        map.put("é˜Ÿåˆ—é•¿åº¦",size);
        map.put("ä»»åŠ¡æ€»æ•°",taskCount);
        map.put("å·²æˆåŠŸæ‰§è¡Œçš„ä»»åŠ¡æ•°",taskCount);
        map.put("æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹æ•°",activeCount);
        return map;
    }
}
```

ä½¿ç”¨æ¥å£æ–‡æ¡£æäº¤ä»»åŠ¡&æŸ¥çœ‹çº¿ç¨‹æ± ä¿¡æ¯æ¥ç†è§£çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶

##### å¼€å‘

`å®ç°å·¥ä½œæµç¨‹`

1. ç»™chartè¡¨æ–°å¢ä»»åŠ¡çŠ¶æ€å­—æ®µï¼ˆæ¯”å¦‚æ’é˜Ÿä¸­ï¼Œå·²å®Œæˆï¼Œæ‰§è¡Œä¸­ï¼Œå¤±è´¥ï¼‰ã€æ‰§è¡Œä¿¡æ¯å­—æ®µï¼ˆå¯ä»¥è®°å½•ä»»åŠ¡å¤±è´¥çš„åŸå› ç­‰ï¼‰

```sql
create table if not exists chart
(
    id          bigint auto_increment comment 'id' primary key,
    goal        text                                   null comment 'åˆ†æç›®æ ‡',
    rawData     text                                   null comment 'åŸå§‹æ•°æ®',
    chartType   varchar(128)                           null comment 'å›¾è¡¨ç±»å‹',
    chartName   varchar(128)                           null comment 'å›¾è¡¨åç§°',
    genChart    text                                   null comment 'AIç”Ÿæˆçš„å›¾è¡¨æ•°æ®',
    genSummary  text                                   null comment 'AIç”Ÿæˆçš„åˆ†ææ€»ç»“',
    userId      bigint                                 null comment 'åˆ›å»ºäººid',
    status      varchar(128) default 'wait'            not null comment 'wait,succeeded,failed,running',
    execMessage text                                   null comment 'æ‰§è¡Œä¿¡æ¯',
    createTime  datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime  datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete    tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤'
) comment 'å›¾è¡¨ä¿¡æ¯' collate = utf8mb4_unicode_ci;
```

2. ç”¨æˆ·ç‚¹å‡»æ™ºèƒ½åˆ†æé¡µçš„æäº¤æŒ‰é’®ï¼Œå…ˆæŠŠå›¾è¡¨ç«‹åˆ»ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åæäº¤ä»»åŠ¡

3. ä»»åŠ¡ï¼šå…ˆä¿®æ”¹å›¾è¡¨çš„ä»»åŠ¡çŠ¶æ€ä¸ºâ€œæ‰§è¡Œä¸­â€ï¼›ç­‰æ‰§è¡ŒæˆåŠŸåï¼Œä¿®æ”¹ä¸ºâ€œå·²å®Œæˆâ€ï¼Œä¿å­˜æ‰§è¡Œç»“æœï¼›æ‰§è¡Œå¤±è´¥åï¼Œä¿®æ”¹ä¸ºå¤±è´¥ï¼Œè®°å½•å¤±è´¥ä¿¡æ¯

```java
/**
 * æ™ºèƒ½åˆ†æï¼ˆå¼‚æ­¥ï¼‰
 *
 * @param multipartFile
 * @param genChartRequest
 * @param request
 * @return
 */
@PostMapping("/gen")
public BaseResponse<BIResponse> genChartByAI(@RequestPart("file") MultipartFile multipartFile,
                                             GenChartRequest genChartRequest, HttpServletRequest request) {
    String goal = genChartRequest.getGoal();
    String chartType = genChartRequest.getChartType();
    String chartName = genChartRequest.getChartName();
    // æ‹¼æ¥åˆ†æç›®æ ‡
    if (StringUtils.isNotBlank(chartType)) {
        goal = goal + "ï¼Œè¯·ä½¿ç”¨" + chartType;
    }
    // æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(StringUtils.isBlank(goal), ErrorCode.PARAMS_ERROR, "åˆ†æç›®æ ‡ä¸ºç©º");
    ThrowUtils.throwIf(StringUtils.isNotBlank(chartName) && chartName.length() > 128, ErrorCode.PARAMS_ERROR, "å›¾è¡¨åç§°è¿‡é•¿");
    // æ ¡éªŒæ–‡ä»¶
    long size = multipartFile.getSize();
    String originalFilename = multipartFile.getOriginalFilename();
    // æ ¡éªŒæ–‡ä»¶å¤§å°
    final long ONE_MB = 1024 * 1024L;
    ThrowUtils.throwIf(size > ONE_MB, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°è¶…è¿‡ 1M");
    // æ ¡éªŒæ–‡ä»¶åç¼€
    String suffix = FileUtil.getSuffix(originalFilename);
    final List<String> validFileSuffix = Arrays.asList("xlsx");
    ThrowUtils.throwIf(!validFileSuffix.contains(suffix), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶åç¼€ä¸ç¬¦åˆè¦æ±‚");
    // è·å–ç™»å½•ç”¨æˆ·
    User loginUser = userService.getLoginUser(request);
    // é™æµ,æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªé™æµå™¨
    redisLimiterManager.doRateLimit("genChartByAI_" + loginUser.getId().toString());
    // å‹ç¼©åŸå§‹æ•°æ®
    String data = ExcelUtils.excelToCsv(multipartFile);
    // æ„é€ ç”¨æˆ·è¯·æ±‚ï¼ˆåˆ†æç›®æ ‡ï¼Œå›¾è¡¨åç§°ï¼Œå›¾è¡¨ç±»å‹ï¼Œcsvæ•°æ®ï¼‰
    StringBuilder userInput = new StringBuilder();
    userInput.append("åˆ†æéœ€æ±‚ï¼š").append("\n");
    userInput.append(goal).append("\n");
    userInput.append("åŸå§‹æ•°æ®ï¼š").append("\n");
    userInput.append(data).append("\n");
    // æ’å…¥æ•°æ®åº“
    Chart chart = new Chart();
    chart.setGoal(goal);
    chart.setRawData(data);
    chart.setChartType(chartType);
    chart.setChartName(chartName);
    chart.setUserId(loginUser.getId());
    chart.setStatus("wait");
    boolean save = chartService.save(chart);
    ThrowUtils.throwIf(!save, ErrorCode.SYSTEM_ERROR, "å›¾è¡¨ä¿å­˜å¤±è´¥");
    //todo å¤„ç†ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†åï¼ŒæŠ›å¼‚å¸¸çš„æƒ…å†µ
    CompletableFuture.runAsync(() -> {
        //å…ˆä¿®æ”¹å›¾è¡¨çš„ä»»åŠ¡çŠ¶æ€ä¸ºâ€œæ‰§è¡Œä¸­â€ï¼›ç­‰æ‰§è¡ŒæˆåŠŸåï¼Œä¿®æ”¹ä¸ºâ€œå·²å®Œæˆâ€ï¼Œä¿å­˜æ‰§è¡Œç»“æœï¼›æ‰§è¡Œå¤±è´¥åï¼Œä¿®æ”¹ä¸ºå¤±è´¥ï¼Œè®°å½•å¤±è´¥ä¿¡æ¯
        //ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ä¸ºæ‰§è¡Œä¸­ï¼Œå‡å°‘é‡å¤æ‰§è¡Œçš„é£é™©ã€åŒæ—¶è®©ç”¨æˆ·çŸ¥æ™“æ‰§è¡ŒçŠ¶æ€
        Chart updateChart = new Chart();
        updateChart.setId(chart.getId());
        updateChart.setStatus("running");
        boolean result = chartService.updateById(updateChart);
        if (!result) {
            handleChartUpdateError(chart.getId(),"æ›´æ–°å›¾è¡¨æ‰§è¡Œä¸­çŠ¶æ€å¤±è´¥");
            return;
        }
        // è°ƒç”¨é±¼èªæ˜SDKï¼Œå¾—åˆ°å“åº”
        long biModelId = 1719916921023344642L;
        String answer = aiManager.doChat(biModelId, userInput.toString());
        // ä»AIå“åº”ç»“æœä¸­ï¼Œå–å‡ºéœ€è¦çš„æ•°æ®
        String[] splits = answer.split("ã€ã€ã€ã€ã€");
        if (splits.length < 3) {
            handleChartUpdateError(chart.getId(),"AIç”Ÿæˆé”™è¯¯");
            return;
        }
        String genChart = splits[1].trim();
        String genSummary = splits[2].trim();
        //æ‰§è¡ŒæˆåŠŸ
        Chart updateChartResult = new Chart();
        updateChartResult.setId(chart.getId());
        //todo å»ºè®®å®šä¹‰çŠ¶æ€ä¸ºæšä¸¾å€¼
        updateChartResult.setStatus("succeeded");
        updateChartResult.setGenChart(genChart);
        updateChartResult.setGenSummary(genSummary);
        result = chartService.updateById(updateChartResult);
        if (!result) {
            handleChartUpdateError(chart.getId(),"æ›´æ–°å›¾è¡¨å·²å®ŒæˆçŠ¶æ€å¤±è´¥");
            return;
        }
    },threadPoolExecutor);
    // è¿”å›ç»™å‰ç«¯
    BIResponse biResponse = new BIResponse();
    biResponse.setChartId(chart.getId());
    return ResultUtils.success(biResponse);
}
private void handleChartUpdateError(long chartId, String execMessage) {
    Chart updateChart = new Chart();
    updateChart.setId(chartId);
    updateChart.setStatus("failed");
    updateChart.setExecMessage(execMessage);
    boolean result = chartService.updateById(updateChart);
    if (!result) {
        log.error("æ›´æ–°å›¾è¡¨å¤±è´¥çŠ¶æ€å¤±è´¥ï¼Œ" + chartId + "ï¼Œ" + execMessage);
    }
}
```

4. ç”¨æˆ·å¯ä»¥åœ¨ä¸ªäººå›¾è¡¨é¡µé¢æŸ¥çœ‹æ‰€æœ‰å›¾è¡¨ï¼ˆå·²ç”Ÿæˆï¼Œç”Ÿæˆä¸­ï¼Œç”Ÿæˆå¤±è´¥ï¼‰çš„ä¿¡æ¯å’ŒçŠ¶æ€ï¼ˆä¿®æ”¹ä¸ªäººå›¾è¡¨é¡µé¢ï¼‰

5. ç”¨æˆ·å¯ä»¥ä¿®æ”¹ç”Ÿæˆå¤±è´¥çš„å›¾è¡¨ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»é‡æ–°ç”Ÿæˆï¼ˆæš‚æœªå®Œæˆï¼‰

##### ä¼˜åŒ–ç‚¹

1. guava retrying é‡è¯•
2. æå‰è€ƒè™‘åˆ°AIç”Ÿæˆé”™è¯¯çš„æƒ…å†µï¼Œåœ¨åç«¯è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼ˆæ¯”å¦‚AIç”Ÿæˆäº†å¤šä½™çš„å†…å®¹ï¼Œæå–æ­£ç¡®çš„å†…å®¹ï¼‰
3. å¦‚æœè¯´ä»»åŠ¡æ ¹æœ¬æ²¡æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼ˆæˆ–è€…é˜Ÿåˆ—æ»¡äº†ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å®šæ—¶ä»»åŠ¡æŠŠå¤±è´¥çŠ¶æ€çš„å›¾è¡¨æ”¾åˆ°é˜Ÿåˆ—ä¸­	
4. å»ºè®®ç»™ä»»åŠ¡çš„æ‰§è¡Œå¢åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åè‡ªåŠ¨æ ‡è®°ä¸ºå¤±è´¥ 
5. åå‘å‹åŠ›https://zhuanlan.zhihu.com/p/404993753 åˆ¤æ–­ç¬¬ä¸‰æ–¹æœåŠ¡çš„çŠ¶æ€æ¥é€‰æ‹©å½“å‰ç³»ç»Ÿçš„ç­–ç•¥ï¼ˆæ¯”å¦‚æ ¹æ®AIæœåŠ¡çš„å½“å‰ä»»åŠ¡é˜Ÿåˆ—æ¥æ§åˆ¶æˆ‘ä»¬ç³»ç»Ÿçš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç³»ç»Ÿèµ„æº
6. ä¸ªäººå›¾è¡¨é¡µé¢å¢åŠ ä¸€ä¸ªåˆ·æ–°æŒ‰é’®æˆ–å®šæ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œä¿è¯è·å–åˆ°å›¾è¡¨çš„æœ€æ–°çŠ¶æ€ï¼ˆå‰ç«¯è½®è¯¢ï¼‰
7. ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥ç»™ç”¨æˆ·å‘é€æ¶ˆæ¯é€šçŸ¥





### åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—

#### åˆ†æç³»ç»Ÿç°çŠ¶çš„ä¸è¶³

> å•æœºç³»ç»Ÿçš„é—®é¢˜

**1ã€æ— æ³•é›†ä¸­é™åˆ¶ï¼Œåªèƒ½å•æœºé™åˆ¶**

å·²ç»ç»è¿‡äº†åŒæ­¥åˆ°å¼‚æ­¥çš„æ”¹é€ ã€‚ç›®å‰çš„å¼‚æ­¥æ˜¯é€šè¿‡æœ¬åœ°çš„çº¿ç¨‹æ± å®ç°çš„ã€‚

å‡å¦‚AIæœåŠ¡é™åˆ¶åªèƒ½æœ‰2ä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨ï¼Œå¯ä»¥è®¾ç½®çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º2æ¥å®ç°

å‡è®¾ç³»ç»Ÿç”¨é‡å¢å¤§ï¼Œæ”¹ä¸ºåˆ†å¸ƒå¼ï¼Œå¤šå°æœåŠ¡å™¨ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½è¦æœ‰2ä¸ªçº¿ç¨‹ï¼Œå°±å¯èƒ½æœ‰2Nä¸ªçº¿ç¨‹



è§£å†³æ–¹æ¡ˆï¼šåœ¨ä¸€ä¸ªé›†ä¸­çš„åœ°æ–¹å»ç®¡ç†ä¸‹å‘ä»»åŠ¡ï¼ˆæ¯”å¦‚é›†ä¸­å­˜å‚¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°ï¼‰



**2ã€ä»»åŠ¡æ”¾åœ¨å†…å­˜ä¸­ï¼ˆArrayBlockingQueueï¼‰æ‰§è¡Œçš„ï¼Œå¯èƒ½ä¼šä¸¢å¤±**

è™½ç„¶å¯ä»¥äººå·¥ä»æ•°æ®åº“æå‡ºæ¥å†é‡è¯•ï¼Œä½†æ˜¯éœ€è¦é¢å¤–å¼€å‘ï¼ˆæ¯”å¦‚å®šæ—¶ä»»åŠ¡ï¼‰ï¼Œè¿™ç§é‡è¯•çš„åœºæ™¯æ˜¯éå¸¸å…¸å‹çš„ï¼Œå…¶å®æ˜¯ä¸éœ€è¦å¼€å‘è€…è¿‡äºå…³å¿ƒã€æˆ–è€…è‡ªå·±å®ç°çš„



è§£å†³æ–¹æ¡ˆï¼šæŠŠä»»åŠ¡æ”¾åœ¨ä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–å­˜å‚¨çš„ç¡¬ç›˜ä¸­



**3ã€å¦‚æœéšç€ç³»ç»ŸåŠŸèƒ½å¢å¤šï¼Œé•¿è€—æ—¶ä»»åŠ¡ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œç³»ç»Ÿå°±ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼ˆæ¯”å¦‚è¦å¼€å¤šä¸ªçº¿ç¨‹æ± ï¼Œèµ„æºå¯èƒ½ä¼šå‡ºç°æŠ¢å ï¼‰**

æœåŠ¡æ‹†åˆ†ï¼ˆåº”ç”¨è§£è€¦ï¼‰ï¼šå¯ä»¥æŠŠé•¿è€—æ—¶ï¼Œæ¶ˆè€—å¾ˆå¤šçš„ä»»åŠ¡å•ç‹¬æŠ½æˆä¸€ä¸ªç¨‹åºï¼Œä¸è¦å½±å“ä¸»é¡µåŠ¡



è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥æœ‰ä¸€ä¸ªä¸­é—´äººï¼Œè®©ä¸­é—´äººå¸®æˆ‘ä»¬å»è¿æ¥ä¸¤ä¸ªç³»ç»Ÿï¼ˆæ¯”å¦‚æ ¸å¿ƒç³»ç»Ÿå’Œæ™ºèƒ½åˆ†æä¸šåŠ¡ï¼‰



#### ä¸­é—´ä»¶

è¿æ¥å¤šä¸ªç³»ç»Ÿï¼Œå¸®åŠ©å¤šä¸ªç³»ç»Ÿç´§å¯†åä½œçš„æŠ€æœ¯ï¼ˆç»„ä»¶ï¼‰

æ¯”å¦‚ï¼šRedisã€æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ†å¸ƒå¼å­˜å‚¨ Etcd



#### æ¶ˆæ¯é˜Ÿåˆ—

å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œå¯ä»¥ç†è§£ä¸ºç‰¹æ®Šçš„æ•°æ®åº“

å…³é”®è¯ï¼šå­˜å‚¨ï¼Œæ¶ˆæ¯ï¼Œé˜Ÿåˆ—

å­˜å‚¨ï¼šå­˜æ•°æ®

æ¶ˆæ¯ï¼šæŸç§æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ï¼Œå¯¹è±¡ï¼ŒäºŒè¿›åˆ¶æ•°æ®ï¼Œjsonç­‰ç­‰

é˜Ÿåˆ—ï¼šå…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„

åº”ç”¨åœºæ™¯ï¼ˆä½œç”¨ï¼‰ï¼šåœ¨å¤šä¸ªä¸åŒçš„ç³»ç»Ÿï¼Œåº”ç”¨ä¹‹é—´å®ç°æ¶ˆæ¯çš„ä¼ è¾“ã€‚ä¸éœ€è¦è€ƒè™‘åº”ç”¨çš„ç¼–ç¨‹è¯­è¨€ã€ç³»ç»Ÿã€æ¡†æ¶ç­‰ã€‚

â€‹	æ¯”å¦‚å¯ä»¥è®©Javaåº”ç”¨å‘æ¶ˆæ¯ï¼Œphpåº”ç”¨æ”¶æ¶ˆæ¯ï¼Œè¿™æ ·å°±ä¸ç”¨æŠŠæ‰€æœ‰ä»£ç å†™åˆ°åŒä¸€ä¸ªé¡¹ç›®é‡Œï¼ˆåº”ç”¨è§£è€¦ï¼‰

##### æ¶ˆæ¯é˜Ÿåˆ—çš„æ¨¡å‹

ç”Ÿäº§è€…ï¼šProducer

æ¶ˆè´¹è€…ï¼šComsumer

æ¶ˆæ¯ï¼šMessage

æ¶ˆæ¯é˜Ÿåˆ—ï¼šQueue

ä¸ºä»€ä¹ˆä¸ç›´æ¥ä¼ è¾“ï¼Œè¦ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…ä¸ç”¨å…³å¿ƒæ¶ˆè´¹è€…è¦ä¸è¦æ¶ˆè´¹ï¼Œä»€ä¹ˆæ—¶å€™æ¶ˆè´¹ï¼Œåªéœ€è¦æŠŠäº§å“ç»™æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”Ÿæˆè€…çš„å·¥ä½œå°±å®Œæˆäº†ã€‚

æ¶ˆè´¹è€…ä»€ä¹ˆæ—¶å€™æœ‰ç©ºå°±å»æ¶ˆè´¹ï¼Œè¿™æ ·ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å°±å®ç°ç±»è§£è€¦ï¼Œäº’ä¸å½±å“ã€‚

![image-20231104190110168](assets/image-20231104190110168.png)

##### ä¸ºä»€ä¹ˆè¦ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

1ï¼‰å¼‚æ­¥å¤„ç†
ç”Ÿäº§è€…å‘é€å®Œæ¶ˆæ¯ä¹‹åï¼Œå¯ä»¥ç»§ç»­å»å¿™åˆ«çš„ï¼Œæ¶ˆè´¹è€…æƒ³ä»€ä¹ˆæ—¶å€™æ¶ˆè´¹éƒ½å¯ä»¥ï¼Œä¸ä¼šäº§ç”Ÿé˜»å¡ã€‚
2ï¼‰å‰Šå³°å¡«è°·
å…ˆæŠŠç”¨æˆ·çš„è¯·æ±‚æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…ï¼ˆå®é™…æ‰§è¡Œæ“ä½œçš„åº”ç”¨ï¼‰å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚ï¼Œæ…¢æ…¢å»å–ã€‚
åŸæœ¬ï¼š12 ç‚¹æ—¶æ¥äº† 10 ä¸‡ä¸ªè¯·æ±‚ï¼ŒåŸæœ¬æƒ…å†µä¸‹ï¼Œ10ä¸‡ä¸ªè¯·æ±‚éƒ½åœ¨ç³»ç»Ÿå†…éƒ¨ç«‹åˆ»å¤„ç†ï¼Œå¾ˆå¿«ç³»ç»Ÿå‹åŠ›è¿‡å¤§å°±å®•æœºäº†ã€‚
ç°åœ¨ï¼šæŠŠè¿™ 10ä¸‡ä¸ªè¯·æ±‚æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¤„ç†ç³»ç»Ÿä»¥è‡ªå·±çš„æ’å®šé€Ÿç‡ï¼ˆæ¯”å¦‚æ¯ç§’ 1 ä¸ªï¼‰æ…¢æ…¢æ‰§è¡Œï¼Œä»è€Œä¿æŠ¤ç³»ç»Ÿã€ç¨³å®šå¤„ç†ã€‚

åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜åŠ¿
1ã€æ•°æ®æŒä¹…åŒ–ï¼šå®ƒå¯ä»¥æŠŠæ¶ˆæ¯é›†ä¸­å­˜å‚¨åˆ°ç¡¬ç›˜é‡Œï¼ŒæœåŠ¡å™¨é‡å¯å°±ä¸ä¼šä¸¢å¤±
2ã€å¯æ‰©å±•æ€§ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚ï¼Œéšæ—¶å¢åŠ ï¼ˆæˆ–å‡å°‘ï¼‰èŠ‚ç‚¹ï¼Œç»§ç»­ä¿æŒç¨³å®šçš„æœåŠ¡
3ã€åº”ç”¨è§£è€¦ï¼šå¯ä»¥è¿æ¥å„ä¸ªä¸åŒè¯­è¨€ã€æ¡†æ¶å¼€å‘çš„ç³»ç»Ÿï¼Œè®©è¿™äº›ç³»ç»Ÿèƒ½å¤Ÿçµæ´»ä¼ è¾“è¯»å–æ•°æ®

åº”ç”¨è§£è€¦çš„ä¼˜ç‚¹ï¼š

ä»¥å‰ï¼ŒæŠŠæ‰€æœ‰åŠŸèƒ½æ”¾åˆ°åŒä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œè°ƒç”¨å¤šä¸ªå­åŠŸèƒ½æ—¶ï¼Œä¸€ä¸ªç¯èŠ‚é”™ï¼Œç³»ç»Ÿå°±æ•´ä½“å‡ºé”™ï¼š

![image-20231104190746826](assets/image-20231104190746826.png)

ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè§£è€¦ï¼š

1. ä¸€ä¸ªç³»ç»ŸæŒ‚äº†ï¼Œä¸å½±å“å¦ä¸€ä¸ªç³»ç»Ÿ
2. ç³»ç»ŸæŒ‚äº†å¹¶æ¢å¤åï¼Œä»ç„¶å¯ä»¥å–å‡ºæ¶ˆæ¯ï¼Œç»§ç»­æ‰§è¡Œä¸šåŠ¡é€»è¾‘
3. åªè¦å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œå°±å¯ä»¥ç«‹åˆ»è¿”å›ï¼Œä¸ç”¨åŒæ­¥è°ƒç”¨æ‰€æœ‰ç³»ç»Ÿï¼Œæ€§èƒ½æ›´é«˜

![image-20231104190910228](assets/image-20231104190910228.png)

4ã€å‘å¸ƒè®¢é˜…

å¦‚æœä¸€ä¸ªéå¸¸å¤§çš„ç³»ç»Ÿè¦ç»™å…¶ä»–å­ç³»ç»Ÿå‘é€é€šçŸ¥ï¼Œæœ€ç®€å•ç›´æ¥çš„æ–¹å¼æ˜¯å¤§ç³»ç»Ÿç›´æ¥ä¾æ¬¡è°ƒç”¨å°ç³»ç»Ÿï¼š
é—®é¢˜ï¼š

1. æ¯æ¬¡å‘é€šçŸ¥éƒ½è¦è°ƒç”¨å¾ˆå¤šç³»ç»Ÿï¼Œå¾ˆéº»çƒ¦ã€æœ‰å¯èƒ½å¤±è´¥
2. æ–°å‡ºç°çš„é¡¹ç›®ï¼ˆæˆ–è€…è¯´å¤§é¡¹ç›®æ„ŸçŸ¥ä¸åˆ°çš„é¡¹ç›®ï¼‰æ— æ³•å¾—åˆ°é€šçŸ¥

![image-20231104191315894](assets/image-20231104191315894.png)

è§£å†³æ–¹æ¡ˆï¼šå¤§çš„æ ¸å¿ƒç³»ç»Ÿå§‹ç»ˆå¾€ä¸€ä¸ªåœ°æ–¹ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰å»å‘æ¶ˆæ¯ï¼Œå…¶ä»–çš„ç³»ç»Ÿéƒ½å»è®¢é˜…è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè¯»å–è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼‰

![image-20231104191514495](assets/image-20231104191514495.png)

##### åº”ç”¨åœºæ™¯

1. è€—æ—¶çš„åœºæ™¯ï¼ˆå¼‚æ­¥ï¼‰
2. é«˜å¹¶å‘åœºæ™¯ï¼ˆå¼‚æ­¥ã€å‰Šå³°å¡«è°·ï¼‰
3. åˆ†å¸ƒå¼ç³»ç»Ÿåä½œï¼ˆå°¤å…¶æ˜¯è·¨å›¢é˜Ÿã€è·¨ä¸šåŠ¡åä½œï¼Œåº”ç”¨è§£è€¦ï¼‰
4. å¼ºç¨³å®šæ€§çš„åœºæ™¯ï¼ˆæ¯”å¦‚é‡‘èä¸šåŠ¡ï¼ŒæŒä¹…åŒ–ã€å¯é æ€§ã€å‰Šå³°å¡«è°·ï¼‰

##### æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹
è¦ç»™ç³»ç»Ÿå¼•å…¥é¢å¤–çš„ä¸­é—´ä»¶ï¼Œç³»ç»Ÿä¼šæ›´å¤æ‚ã€é¢å¤–ç»´æŠ¤ä¸­é—´ä»¶ã€é¢å¤–çš„è´¹ç”¨ï¼ˆéƒ¨ç½²ï¼‰æˆæœ¬
æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯ä¸¢å¤±ã€é¡ºåºæ€§ã€é‡å¤æ¶ˆè´¹ã€æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆåˆ†å¸ƒå¼ç³»ç»Ÿå°±è¦è€ƒè™‘ï¼‰



####  ä¸»æµåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹
**ä¸»æµæŠ€æœ¯**

1. activemq
2. rabbitmq
3. kafka
4. rocketmq
5. zeromq
6. pulsarï¼ˆäº‘åŸç”Ÿï¼‰
7. Apache InLongï¼ˆTubeï¼‰

**æŠ€æœ¯å¯¹æ¯”**
æŠ€æœ¯é€‰å‹æŒ‡æ ‡ï¼š

- ååé‡ï¼šIOã€å¹¶å‘
- æ—¶æ•ˆæ€§ï¼šç±»ä¼¼å»¶è¿Ÿï¼Œæ¶ˆæ¯çš„å‘é€ã€åˆ°è¾¾æ—¶é—´
- å¯ç”¨æ€§ï¼šç³»ç»Ÿå¯ç”¨çš„æ¯”ç‡ï¼ˆæ¯”å¦‚ 1 å¹´ 365 å¤©å®•æœº 1sï¼Œå¯ç”¨ç‡å¤§æ¦‚ X ä¸ª 9ï¼‰
- å¯é æ€§ï¼šæ¶ˆæ¯ä¸ä¸¢å¤±ï¼ˆæ¯”å¦‚ä¸ä¸¢å¤±è®¢å•ï¼‰ã€åŠŸèƒ½æ­£å¸¸å®Œæˆ 

| æŠ€æœ¯åç§° | ååé‡ | æ—¶æ•ˆæ€§         | å¯ç”¨æ€§ | å¯é æ€§ | ä¼˜åŠ¿                                                       | åº”ç”¨åœºæ™¯                                                     |
| -------- | :----: | -------------- | ------ | ------ | ---------------------------------------------------------- | ------------------------------------------------------------ |
| activemq |  ä¸‡çº§  | é«˜             | é«˜     | é«˜     | ç®€å•æ˜“å­¦                                                   | ä¸­å°å‹ä¼ä¸šã€é¡¹ç›®                                             |
| rabbitmq |  ä¸‡çº§  | æé«˜ï¼ˆå¾®ç§’ï¼‰   | é«˜     | é«˜     | ç”Ÿæ€å¥½ï¼ˆåŸºæœ¬ä»€ä¹ˆè¯­è¨€éƒ½æ”¯æŒï¼‰ã€æ—¶æ•ˆæ€§é«˜ã€æ˜“å­¦               | é€‚åˆç»å¤§å¤šæ•°åˆ†å¸ƒå¼çš„åº”ç”¨ï¼Œè¿™ä¹Ÿæ˜¯å…ˆå­¦ä»–çš„åŸå›                  |
| kafka    | åä¸‡çº§ | é«˜ï¼ˆæ¯«ç§’ä»¥å†…ï¼‰ | æé«˜   | æé«˜   | ååé‡å¤§ã€å¯é æ€§ã€å¯ç”¨æ€§ï¼Œå¼ºå¤§çš„æ•°æ®æµå¤„ç†èƒ½åŠ›             | é€‚ç”¨äº å¤§è§„æ¨¡å¤„ç†æ•°æ®çš„åœºæ™¯ï¼Œæ¯”å¦‚æ„å»ºæ—¥å¿—æ”¶é›†ç³»ç»Ÿã€å®æ—¶æ•°æ®æµä¼ è¾“ã€äº‹ä»¶æµæ”¶é›†ä¼ è¾“ |
| rocketmq | åä¸‡çº§ | é«˜ï¼ˆmsï¼‰       | æé«˜   | æé«˜   | ååé‡å¤§ã€å¯é æ€§ã€å¯ç”¨æ€§ï¼Œå¯æ‰©å±•æ€§                         | é€‚ç”¨äº é‡‘è ã€ç”µå•†ç­‰å¯¹å¯é æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œé€‚åˆ å¤§è§„æ¨¡ çš„æ¶ˆæ¯å¤„ç†ã€‚ |
| pulsar   | åä¸‡çº§ | é«˜ï¼ˆmsï¼‰       | æé«˜   | æé«˜   | å¯é æ€§ã€å¯ç”¨æ€§å¾ˆé«˜ï¼ŒåŸºäºå‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ–°å…´ï¼ˆæŠ€æœ¯æ¶æ„å…ˆè¿›ï¼‰ | é€‚åˆå¤§è§„æ¨¡ã€é«˜å¹¶å‘çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆäº‘åŸç”Ÿï¼‰ã€‚é€‚åˆå®æ—¶åˆ†æã€äº‹ä»¶æµå¤„ç†ã€IoT æ•°æ®å¤„ç†ç­‰ã€‚ |

#### RabbitMQ å…¥é—¨å®æˆ˜
ç‰¹ç‚¹ï¼šç”Ÿæ€å¥½ï¼Œå¥½å­¦ä¹ ã€æ˜“äºç†è§£ï¼Œæ—¶æ•ˆæ€§å¼ºï¼Œæ”¯æŒå¾ˆå¤šä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œæ‰©å±•æ€§ã€å¯ç”¨æ€§éƒ½å¾ˆä¸é”™ã€‚
å­¦ä¹ æ€§ä»·æ¯”éå¸¸é«˜çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€‚ç”¨äºç»å¤§å¤šæ•°ä¸­å°è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

å®˜æ–¹ç½‘ç«™ï¼šhttps://www.rabbitmq.com

å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/getstarted.html

##### åŸºæœ¬æ¦‚å¿µ
AMQP åè®®ï¼šhttps://www.rabbitmq.com/tutorials/amqp-concepts.html
é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAdvanced Message Queue Protocolï¼‰

ç”Ÿäº§è€…ï¼šå‘æ¶ˆæ¯åˆ°æŸä¸ªäº¤æ¢æœº
æ¶ˆè´¹è€…ï¼šä»æŸä¸ªé˜Ÿåˆ—ä¸­å–æ¶ˆæ¯
äº¤æ¢æœºï¼ˆExchangeï¼‰ï¼šè´Ÿè´£æŠŠæ¶ˆæ¯ **è½¬å‘** åˆ°å¯¹åº”çš„é˜Ÿåˆ—
é˜Ÿåˆ—ï¼ˆQueueï¼‰ï¼šå­˜å‚¨æ¶ˆæ¯çš„
è·¯ç”±ï¼ˆRoutesï¼‰ï¼šè½¬å‘ï¼Œå°±æ˜¯æ€ä¹ˆæŠŠæ¶ˆæ¯ä»ä¸€ä¸ªåœ°æ–¹è½¬åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆæ¯”å¦‚ä»ç”Ÿäº§è€…è½¬å‘åˆ°æŸä¸ªé˜Ÿåˆ—ï¼‰

![image-20231104193315241](assets/image-20231104193315241.png)



##### å®‰è£…
å¿«é€Ÿå¼€å§‹ï¼šhttps://www.rabbitmq.com/#getstarted
windows å®‰è£…ï¼šhttps://www.rabbitmq.com/install-windows.html

![image-20231104193849935](assets/image-20231104193849935.png)

å…ˆå®‰è£… erlang 25.3.2ï¼ˆå› ä¸º RabbitMQ ä¾èµ– erlangï¼‰ï¼Œè¿™ä¸ªè¯­è¨€çš„æ€§èƒ½éå¸¸é«˜ã€‚
erlang ä¸‹è½½ï¼šhttps://www.erlang.org/patches/otp-25.3.2

![image-20231104194202112](assets/image-20231104194202112.png)

å®‰è£…å®Œ erlang åï¼Œå®‰è£… rabbitmq å³å¯ã€‚

![image-20231104194427297](assets/image-20231104194427297.png)

![image-20231104194826351](assets/image-20231104194826351.png)

win+ r è¾“å…¥ services.mscæ‰“å¼€æœåŠ¡èœå•ï¼ŒæŸ¥çœ‹ rabbitmq æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ï¼š

![image-20231104195056779](assets/image-20231104195056779.png)

![image-20231105092129185](assets/image-20231105092129185.png)

å®‰è£… rabbitmq ç›‘æ§é¢æ¿ï¼šhttps://www.rabbitmq.com/rabbitmq-plugins.8.html

åœ¨ rabbitmq å®‰è£…ç›®å½•çš„ sbin ä¸­æ‰§è¡Œä¸‹è¿°è„šæœ¬ï¼š

```sh
rabbitmq-plugins enable rabbitmq_shovel rabbitmq_management
```

![image-20231104195422486](assets/image-20231104195422486.png)

![image-20231104195630794](assets/image-20231104195630794.png)

è¾“å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š

è®¿é—®ï¼šhttp://localhost:15672ï¼Œç”¨æˆ·åå¯†ç éƒ½æ˜¯ guest

![image-20231104195729280](assets/image-20231104195729280.png)

![image-20231104195743693](assets/image-20231104195743693.png)

å¦‚æœæƒ³è¦åœ¨è¿œç¨‹æœåŠ¡å™¨å®‰è£…è®¿é—® rabbitmq ç®¡ç†é¢æ¿ï¼Œä½ è¦è‡ªå·±åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦å·ï¼Œä¸èƒ½ç”¨é»˜è®¤çš„ guestï¼Œå¦åˆ™ä¼šè¢«æ‹¦æˆªï¼ˆå®˜æ–¹å‡ºäºå®‰å…¨è€ƒè™‘ï¼‰ã€‚

å¦‚æœè¢«æ‹¦æˆªï¼Œå¯ä»¥è‡ªå·±åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼š
å‚è€ƒæ–‡æ¡£çš„ Adding a Userï¼šhttps://www.rabbitmq.com/access-control.html

![image-20231105093031433](assets/image-20231105093031433.png)

rabbitmq ç«¯å£å ç”¨ï¼š
5672ï¼šç¨‹åºè¿æ¥çš„ç«¯å£
15672ï¼šwebUI
![image-20231105093515349](assets/image-20231105093515349.png)

##### å¿«é€Ÿå…¥é—¨

MQ å®˜æ–¹æ•™ç¨‹ï¼šhttps://www.rabbitmq.com/getstarted.html

###### **å•å‘å‘é€**
Hello World
æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-one-java.html

ä¸€ä¸ªç”Ÿäº§è€…ç»™ä¸€ä¸ªé˜Ÿåˆ—å‘æ¶ˆæ¯ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ä»è¿™ä¸ªé˜Ÿåˆ—å–æ¶ˆæ¯ã€‚1 å¯¹ 1ã€‚
![image-20231105110131756](assets/image-20231105110131756.png)

1ã€å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ— Java å®¢æˆ·ç«¯ï¼š

```xml
<!-- https://mvnrepository.com/artifact/com.rabbitmq/amqp-client -->
<dependency>
    <groupId>com.rabbitmq</groupId>
    <artifactId>amqp-client</artifactId>
    <version>5.17.0</version>
</dependency>
```

2ã€ç”Ÿäº§è€…ä»£ç ï¼šhttps://github.com/rabbitmq/rabbitmq-tutorials/blob/main/java/Send.java

![image-20231105094636969](assets/image-20231105094636969.png)

```java
public class SingleProducer {

    private final static String QUEUE_NAME = "hello";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        /*//ä¸è®¾ç½®ç”¨æˆ·åå¯†ç ï¼Œé»˜è®¤å°±æ˜¯guestï¼Œç«¯å£é»˜è®¤5672
        factory.setUsername();
        factory.setPassword();
        factory.setPort();*/
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
            channel.queueDeclare(QUEUE_NAME, false, false, false, null);
            // å‘é€æ¶ˆæ¯
            String message = "Hello World!";
            channel.basicPublish("", QUEUE_NAME, null, message.getBytes(StandardCharsets.UTF_8));
            System.out.println(" [x] Sent '" + message + "'");
        }
    }
}
```

Channel é¢‘é“ï¼šç†è§£ä¸ºæ“ä½œæ¶ˆæ¯é˜Ÿåˆ—çš„ clientï¼ˆæ¯”å¦‚ jdbcClientã€redisClientï¼‰ï¼Œæä¾›äº†å’Œæ¶ˆæ¯é˜Ÿåˆ— server å»ºç«‹é€šä¿¡çš„ä¼ è¾“æ–¹æ³•ï¼ˆä¸ºäº†å¤ç”¨è¿æ¥ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ï¼‰ã€‚ç¨‹åºé€šè¿‡ channel æ“ä½œ rabbitmqï¼ˆæ”¶å‘æ¶ˆæ¯ï¼‰

åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—å‚æ•°ï¼š

```
Queue.DeclareOk queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete,
                             Map<String, Object> arguments) throws IOException;
```

queueï¼šæ¶ˆæ¯é˜Ÿåˆ—åç§°ï¼ˆæ³¨æ„ï¼ŒåŒåç§°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªèƒ½ç”¨åŒæ ·çš„å‚æ•°åˆ›å»ºä¸€æ¬¡ï¼‰
durabaleï¼šæ¶ˆæ¯é˜Ÿåˆ—é‡å¯åï¼Œæ¶ˆæ¯æ˜¯å¦ä¸¢å¤±
exclusiveï¼šæ˜¯å¦åªå…è®¸å½“å‰è¿™ä¸ªåˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—çš„è¿æ¥æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—
autoDeleteï¼šæ²¡æœ‰äººç”¨é˜Ÿåˆ—åï¼Œæ˜¯å¦è¦åˆ é™¤é˜Ÿåˆ—

argumentsï¼šæœ‰éœ€è¦æ‰ä¼ 

æ‰§è¡Œç¨‹åºåï¼Œå¯ä»¥çœ‹åˆ°æœ‰ 1 æ¡æ¶ˆæ¯ï¼š

![image-20231105100113104](assets/image-20231105100113104.png)

3ã€æ¶ˆè´¹è€…ä»£ç ï¼šhttps://github.com/rabbitmq/rabbitmq-tutorials/blob/main/java/Recv.java

![image-20231105100230288](assets/image-20231105100230288.png)

```java
public class SingleConsumer {

    private final static String QUEUE_NAME = "hello";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
        // å®šä¹‰äº†å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), StandardCharsets.UTF_8);
            System.out.println(" [x] Received '" + message + "'");
        };
        // æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¼šæŒç»­é˜»å¡
        channel.basicConsume(QUEUE_NAME, true, deliverCallback, consumerTag -> { });
    }
}
```

å¯åŠ¨æ¶ˆè´¹è€…åï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯è¢«æ¶ˆè´¹äº†ï¼š
![image-20231105100749864](assets/image-20231105100749864.png)

![image-20231105101018159](assets/image-20231105101018159.png)



###### **å¤šæ¶ˆè´¹è€…**
å®˜æ–¹æ•™ç¨‹ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-two-java.html
åœºæ™¯ï¼šå¤šä¸ªæœºå™¨åŒæ—¶å»æ¥å—å¹¶å¤„ç†ä»»åŠ¡ï¼ˆå°¤å…¶æ˜¯æ¯ä¸ªæœºå™¨çš„å¤„ç†èƒ½åŠ›æœ‰é™ï¼‰
ä¸€ä¸ªç”Ÿäº§è€…ç»™ä¸€ä¸ªé˜Ÿåˆ—å‘æ¶ˆæ¯ï¼Œå¤šä¸ªæ¶ˆè´¹è€… ä»è¿™ä¸ªé˜Ÿåˆ—å–æ¶ˆæ¯ã€‚1 å¯¹å¤šã€‚
![image-20231105101220731](assets/image-20231105101220731.png)

1ï¼‰é˜Ÿåˆ—æŒä¹…åŒ–
durable å‚æ•°è®¾ç½®ä¸º trueï¼ŒæœåŠ¡å™¨é‡å¯åé˜Ÿåˆ—ä¸ä¸¢å¤±ï¼š

```java
channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
```

2ï¼‰æ¶ˆæ¯æŒä¹…åŒ–
æŒ‡å®š MessageProperties.PERSISTENT_TEXT_PLAIN å‚æ•°ï¼š

```java
channel.basicPublish("", TASK_QUEUE_NAME,
        MessageProperties.PERSISTENT_TEXT
        message.getBytes("UTF-8"));
```

ç”Ÿäº§è€…ä»£ç ï¼š
ä½¿ç”¨ Scanner æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä¾¿äºå‘é€å¤šæ¡æ¶ˆæ¯

```java
public class MultiProducer {

    private static final String TASK_QUEUE_NAME = "multi_queue";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
            channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
            // å‘é€æ¶ˆæ¯
            Scanner sc = new Scanner(System.in);
            while (sc.hasNext()) {
                String message = sc.nextLine();
                channel.basicPublish("", TASK_QUEUE_NAME,
                        MessageProperties.PERSISTENT_TEXT_PLAIN,
                        message.getBytes("UTF-8"));
                System.out.println(" [x] Sent '" + message + "'");
            }
        }
    }
}
```

æ§åˆ¶å•ä¸ªæ¶ˆè´¹è€…çš„å¤„ç†ä»»åŠ¡ç§¯å‹æ•°ï¼š
æ¯ä¸ªæ¶ˆè´¹è€…æœ€å¤šåŒæ—¶å¤„ç† 1 ä¸ªä»»åŠ¡

```java
channel.basicQos(1);
```

æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼š
ä¸ºäº†ä¿è¯æ¶ˆæ¯æˆåŠŸè¢«æ¶ˆè´¹ï¼ˆå¿«é€’æˆåŠŸè¢«å–èµ°ï¼‰ï¼Œrabbitmq æä¾›äº†æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œå½“æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæ¯”å¦‚è¦ç»™ä¸€ä¸ªåé¦ˆï¼š

- ackï¼šæ¶ˆè´¹æˆåŠŸ
- nackï¼šæ¶ˆè´¹å¤±è´¥
- rejectï¼šæ‹’ç»

å¦‚æœå‘Šè¯‰ rabbitmq æœåŠ¡å™¨æ¶ˆè´¹æˆåŠŸï¼ŒæœåŠ¡å™¨æ‰ä¼šæ”¾å¿ƒåœ°ç§»é™¤æ¶ˆæ¯ã€‚
æ”¯æŒé…ç½® autoackï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ ack å‘½ä»¤ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯ç«‹åˆ»å°±æˆåŠŸäº†ã€‚

```java
channel.basicConsume(TASK_QUEUE_NAME, false, deliverCallback, consumerTag -> {});
```

å»ºè®® autoack æ”¹ä¸º falseï¼Œæ ¹æ®å®é™…æƒ…å†µï¼Œå»æ‰‹åŠ¨ç¡®è®¤ã€‚ 
æŒ‡å®šç¡®è®¤æŸæ¡æ¶ˆæ¯ï¼š
ç¬¬äºŒä¸ªå‚æ•° multiple æ‰¹é‡ç¡®è®¤ï¼šæ˜¯æŒ‡æ˜¯å¦è¦ä¸€æ¬¡æ€§ç¡®è®¤æ‰€æœ‰çš„å†å²æ¶ˆæ¯ç›´åˆ°å½“å‰è¿™æ¡

```java
 channel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);
```

æŒ‡å®šæ‹’ç»æŸæ¡æ¶ˆæ¯ï¼š
ç¬¬ 3 ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦é‡æ–°å…¥é˜Ÿï¼Œå¯ç”¨äºé‡è¯•

```java
channel.basicNack(delivery.getEnvelope().getDeliveryTag(),false,false );
```

æ¶ˆè´¹è€…ä»£ç ï¼š

```java
public class MultiConsumer {

    private static final String TASK_QUEUE_NAME = "multi_queue";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        final Connection connection = factory.newConnection();
        for (int i = 0; i < 2; i++) {
            final Channel channel = connection.createChannel();
            // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
            channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
            System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
            // æ§åˆ¶æ¯ä¸ªæ¶ˆè´¹è€…æœ€å¤šåŒæ—¶å¤„ç† 1 ä¸ªä»»åŠ¡
            channel.basicQos(1);
            // å®šä¹‰äº†å¦‚ä½•å¤„ç†æ¶ˆæ¯
            int finalI = i;
            DeliverCallback deliverCallback = (consumerTag, delivery) -> {
                String message = new String(delivery.getBody(), "UTF-8");
                try {
                    // å¤„ç†é€»è¾‘
                    System.out.println(" [x] Received ç¼–å·" + finalI + "'" + message + "'");
                    //ç¡20ç§’ï¼Œæ¨¡æ‹Ÿå·¥äººæ¯20ç§’å¤„ç†ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†èƒ½åŠ›æœ‰é™
                    Thread.sleep(20000);
                    // ç¡®è®¤æ¶ˆæ¯
                    channel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);
                } catch (Exception e) {
                    e.printStackTrace();
                    // æ‹’ç»æ¶ˆæ¯
                    channel.basicNack(delivery.getEnvelope().getDeliveryTag(),false,false );
                } finally {
                    System.out.println(" [x] Done");
                }
            };
            // æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¼šæŒç»­é˜»å¡
            channel.basicConsume(TASK_QUEUE_NAME, false, deliverCallback, consumerTag -> {
            });
        }
    }
}
```

2 ä¸ªå°æŠ€å·§ï¼š

1. ä½¿ç”¨ Scanner æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä¾¿äºå¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯
2. ä½¿ç”¨ for å¾ªç¯åˆ›å»ºå¤šä¸ªæ¶ˆè´¹è€…ï¼Œä¾¿äºå¿«é€ŸéªŒè¯é˜Ÿåˆ—æ¨¡å‹å·¥ä½œæœºåˆ¶

###### äº¤æ¢æœº

æ•™ç¨‹ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-three-java.html

ä¸€ä¸ªç”Ÿäº§è€…ç»™ å¤šä¸ª é˜Ÿåˆ—å‘æ¶ˆæ¯ï¼Œ1 ä¸ªç”Ÿäº§è€…å¯¹å¤šä¸ªé˜Ÿåˆ—ã€‚
äº¤æ¢æœºçš„ä½œç”¨ï¼šæä¾›æ¶ˆæ¯è½¬å‘åŠŸèƒ½ï¼Œç±»ä¼¼äºç½‘ç»œè·¯ç”±å™¨
è¦è§£å†³çš„é—®é¢˜ï¼šæ€ä¹ˆæŠŠæ¶ˆæ¯è½¬å‘åˆ°ä¸åŒçš„é˜Ÿåˆ—ä¸Šï¼Œå¥½è®©æ¶ˆè´¹è€…ä»ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚

![image-20231105110056833](assets/image-20231105110056833.png)

ç»‘å®šï¼šäº¤æ¢æœºå’Œé˜Ÿåˆ—å…³è”èµ·æ¥ï¼Œä¹Ÿå¯ä»¥å«è·¯ç”±ï¼Œç®—æ˜¯ä¸€ä¸ªç®—æ³•æˆ–è½¬å‘ç­–ç•¥
ç»‘å®šä»£ç ï¼š

```java
channel.queueBind(queueName, EXCHANGE_NAME, "routingkey");
```

äº¤æ¢æœºæœ‰å¤šç§ç±»åˆ«ï¼šfanoutã€direct, topic, headers

`fanout`
æ‰‡å‡ºã€å¹¿æ’­
ç‰¹ç‚¹ï¼šæ¶ˆæ¯ä¼šè¢«è½¬å‘åˆ°æ‰€æœ‰ç»‘å®šåˆ°è¯¥äº¤æ¢æœºçš„é˜Ÿåˆ—
åœºæ™¯ï¼šå¾ˆé€‚ç”¨äºå‘å¸ƒè®¢é˜…çš„åœºæ™¯ã€‚æ¯”å¦‚å†™æ—¥å¿—ï¼Œå¯ä»¥å¤šä¸ªç³»ç»Ÿé—´å…±äº«

ç¤ºä¾‹åœºæ™¯ï¼š
![image-20231105112941972](assets/image-20231105112941972.png)



ç”Ÿäº§è€…ä»£ç ï¼š

```java
public class FanoutProducer {

    private static final String EXCHANGE_NAME = "fanout-exchange";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºäº¤æ¢æœº
            channel.exchangeDeclare(EXCHANGE_NAME, "fanout");
            Scanner sc = new Scanner(System.in);
            while (sc.hasNext()) {
                String message = sc.nextLine();
                // å‘äº¤æ¢æœºå‘æ¶ˆæ¯
                channel.basicPublish(EXCHANGE_NAME, "", null, message.getBytes("UTF-8"));
                System.out.println(" [x] Sent '" + message + "'");
            }
        }
    }
}
```

æ¶ˆè´¹è€…ä»£ç ï¼š

```java
public class FanoutConsumer {
    private static final String EXCHANGE_NAME = "fanout-exchange";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel1 = connection.createChannel();
        Channel channel2 = connection.createChannel();
        //åˆ›å»ºäº¤æ¢æœº
        channel1.exchangeDeclare(EXCHANGE_NAME, "fanout");
        // åˆ›å»ºé˜Ÿåˆ—
        String queueName1 = "å°ç‹çš„å·¥ä½œé˜Ÿåˆ—";
        String queueName2 = "å°æçš„å·¥ä½œé˜Ÿåˆ—";
        channel1.queueDeclare(queueName1, true, false, false, null);
        channel2.queueDeclare(queueName2, true, false, false, null);
        //ç»‘å®šäº¤æ¢æœº
        channel1.queueBind(queueName1, EXCHANGE_NAME, "");
        channel2.queueBind(queueName2, EXCHANGE_NAME, "");

        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
        // å®šä¹‰äº†å°ç‹å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback1 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [å°ç‹] Received '" + message + "'");
        };
        // å®šä¹‰äº†å°æå¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback2 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [å°æ] Received '" + message + "'");
        };
        // æ¶ˆè´¹æ¶ˆæ¯
        channel1.basicConsume(queueName1, true, deliverCallback1, consumerTag -> {
        });
        channel2.basicConsume(queueName2, true, deliverCallback2, consumerTag -> {
        });
    }
}
```

æ³¨æ„ï¼š

1. æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…è¦ç»‘å®šåŒä¸€ä¸ªäº¤æ¢æœº
2. è¦å…ˆåˆ›å»ºé˜Ÿåˆ—ï¼Œæ‰èƒ½ç»‘å®š

æ•ˆæœï¼šæ‰€æœ‰æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯

`Direct äº¤æ¢æœº`
å®˜æ–¹æ•™ç¨‹ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-four-java.html
ç»‘å®šï¼šå¯ä»¥è®©äº¤æ¢æœºå’Œé˜Ÿåˆ—è¿›è¡Œå…³è”ï¼Œå¯ä»¥æŒ‡å®šè®©äº¤äº’æœºæŠŠä»€ä¹ˆæ ·çš„æ¶ˆæ¯å‘é€ç»™å“ªä¸ªé˜Ÿåˆ—
routingKeyï¼šè·¯ç”±é”®ï¼Œæ§åˆ¶æ¶ˆæ¯è¦è½¬å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼ˆç›¸å½“äºIP åœ°å€ï¼‰ï¼Œä¹Ÿä»£è¡¨äº†é˜Ÿåˆ—è®¢é˜…çš„æ¶ˆæ¯ç±»å‹

ç‰¹ç‚¹ï¼šæ¶ˆæ¯ä¼šæ ¹æ®è·¯ç”±é”®è½¬å‘åˆ°æŒ‡å®šçš„é˜Ÿåˆ—
åœºæ™¯ï¼šç‰¹å®šçš„æ¶ˆæ¯åªäº¤ç»™ç‰¹å®šçš„ç³»ç»Ÿï¼ˆç¨‹åºï¼‰æ¥å¤„ç†
ç»‘å®šå…³ç³»ï¼šå®Œå…¨åŒ¹é…å­—ç¬¦ä¸²
![image-20231105114053528](assets/image-20231105114053528.png)

å¯ä»¥ç»‘å®šåŒæ ·çš„è·¯ç”±é”®ã€‚

æ¯”å¦‚å‘æ—¥å¿—çš„åœºæ™¯ï¼Œå¸Œæœ›ç”¨ç‹¬ç«‹çš„ç¨‹åºæ¥å¤„ç†ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼Œæ¯”å¦‚ C1 ç³»ç»Ÿå¤„ç† error æ—¥å¿—ï¼ŒC2 ç³»ç»Ÿå¤„ç†å…¶ä»–çº§åˆ«çš„æ—¥å¿—

![image-20231105114533952](assets/image-20231105114533952.png)

ç¤ºä¾‹åœºæ™¯ï¼š

![image-20231105114615725](assets/image-20231105114615725.png)

ç”Ÿäº§è€…ä»£ç ï¼š

```java
public class DirectProducer {

    private static final String EXCHANGE_NAME = "direct-exchange";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºäº¤æ¢æœº
            channel.exchangeDeclare(EXCHANGE_NAME, "direct");
            Scanner sc = new Scanner(System.in);
            while (sc.hasNext()) {
                String userInput = sc.nextLine();
                String[] strings = userInput.split(" ");
                if (strings.length < 1) {
                    continue;
                }
                String message = strings[0];
                // ä»è¾“å…¥è·å–è·¯ç”±é”®
                String routingKey = strings[1];
                // å‘äº¤æ¢æœºå‘æ¶ˆæ¯
                channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes("UTF-8"));
                System.out.println(" [x] Sent '" + message + "' with routing:" + routingKey);
            }
        }
    }
}
```

æ¶ˆè´¹è€…ä»£ç ï¼š

```java
public class DirectConsumer {

    private static final String EXCHANGE_NAME = "direct-exchange";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel1 = connection.createChannel();
        Channel channel2 = connection.createChannel();
        // åˆ›å»ºäº¤æ¢æœº
        channel1.exchangeDeclare(EXCHANGE_NAME, "direct");
        // åˆ›å»ºé˜Ÿåˆ—
        String queueName1 = "å°è½çš„å·¥ä½œé˜Ÿåˆ—";
        String queueName2 = "å°æ¨±çš„å·¥ä½œé˜Ÿåˆ—";
        channel1.queueDeclare(queueName1, true, false, false, null);
        channel2.queueDeclare(queueName2, true, false, false, null);
        // ç»‘å®šäº¤æ¢æœºï¼ŒæŒ‡å®šè·¯ç”±é”®
        channel1.queueBind(queueName1, EXCHANGE_NAME, "xiaoluo");
        channel2.queueBind(queueName2, EXCHANGE_NAME, "xiaoying");
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");

        // å®šä¹‰äº†å°è½å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback1 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [å°è½] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
        };
        // å®šä¹‰äº†å°æ¨±å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback2 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [å°æ¨±] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
        };
        // æ¶ˆè´¹æ¶ˆæ¯
        channel1.basicConsume(queueName1, true, deliverCallback1, consumerTag -> {
        });
        channel2.basicConsume(queueName2, true, deliverCallback2, consumerTag -> {
        });
    }
}
```

`topic äº¤æ¢æœº`
å®˜æ–¹æ•™ç¨‹ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-five-java.html
ç‰¹ç‚¹ï¼šæ¶ˆæ¯ä¼šæ ¹æ®ä¸€ä¸ª æ¨¡ç³Šçš„ è·¯ç”±é”®è½¬å‘åˆ°æŒ‡å®šçš„é˜Ÿåˆ—
åœºæ™¯ï¼šç‰¹å®šçš„ä¸€ç±»æ¶ˆæ¯å¯ä»¥äº¤ç»™ç‰¹å®šçš„ä¸€ç±»ç³»ç»Ÿï¼ˆç¨‹åºï¼‰æ¥å¤„ç†
ç»‘å®šå…³ç³»ï¼šå¯ä»¥æ¨¡ç³ŠåŒ¹é…å¤šä¸ªç»‘å®š

- *ï¼šåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œæ¯”å¦‚ *.orangeï¼Œé‚£ä¹ˆ a.orangeã€b.orange éƒ½èƒ½åŒ¹é…
- #ï¼šåŒ¹é… 0 ä¸ªæˆ–å¤šä¸ªå•è¯ï¼Œæ¯”å¦‚ a.#ï¼Œé‚£ä¹ˆ aã€a.aã€a.bã€a.a.a éƒ½èƒ½åŒ¹é…

æ³¨æ„ï¼Œè¿™é‡Œçš„åŒ¹é…å’Œ MySQL çš„like çš„ % ä¸ä¸€æ ·ï¼Œåªèƒ½æŒ‰ç…§å•è¯æ¥åŒ¹é…ï¼Œæ¯ä¸ª '.' åˆ†éš”å•è¯

![image-20231105123339317](assets/image-20231105123339317.png)

åº”ç”¨åœºæ™¯ï¼š
![image-20231105123626226](assets/image-20231105123626226.png)

ç”Ÿäº§è€…ä»£ç ï¼š

```java
public class TopicProducer {

    private static final String EXCHANGE_NAME = "topic-exchange";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºäº¤æ¢æœº
            channel.exchangeDeclare(EXCHANGE_NAME, "topic");
            Scanner sc = new Scanner(System.in);
            while (sc.hasNext()) {
                String userInput = sc.nextLine();
                String[] strings = userInput.split(" ");
                if (strings.length < 1) {
                    continue;
                }
                String message = strings[0];
                // ä»è¾“å…¥è·å–è·¯ç”±é”®
                String routingKey = strings[1];
                // å‘äº¤æ¢æœºå‘æ¶ˆæ¯
                channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes("UTF-8"));
                System.out.println(" [x] Sent '" + message + "' with routing:" + routingKey);
            }
        }
    }
}
```

æ¶ˆè´¹è€…ä»£ç ï¼š

```java
public class TopicConsumer {

    private static final String EXCHANGE_NAME = "topic-exchange";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel1 = connection.createChannel();
        Channel channel2 = connection.createChannel();
        Channel channel3 = connection.createChannel();
        // åˆ›å»ºäº¤æ¢æœº
        channel1.exchangeDeclare(EXCHANGE_NAME, "topic");
        // åˆ›å»ºé˜Ÿåˆ—
        String queueName1 = "å‰ç«¯çš„å·¥ä½œé˜Ÿåˆ—";
        String queueName2 = "åç«¯çš„å·¥ä½œé˜Ÿåˆ—";
        String queueName3 = "äº§å“çš„å·¥ä½œé˜Ÿåˆ—";
        channel1.queueDeclare(queueName1, true, false, false, null);
        channel2.queueDeclare(queueName2, true, false, false, null);
        channel3.queueDeclare(queueName3, true, false, false, null);
        // ç»‘å®šäº¤æ¢æœºï¼ŒæŒ‡å®šè·¯ç”±é”®
        channel1.queueBind(queueName1, EXCHANGE_NAME, "#.å‰ç«¯.#");
        channel2.queueBind(queueName2, EXCHANGE_NAME, "#.åç«¯.#");
        channel3.queueBind(queueName3, EXCHANGE_NAME, "#.äº§å“.#");
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
        // å®šä¹‰äº†å‰ç«¯å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback1 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [å‰ç«¯] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
        };
        // å®šä¹‰äº†åç«¯å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback2 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [åç«¯] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
        };
        // å®šä¹‰äº†äº§å“å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback3 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println(" [äº§å“] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
        };
        // æ¶ˆè´¹æ¶ˆæ¯
        channel1.basicConsume(queueName1, true, deliverCallback1, consumerTag -> {
        });
        channel2.basicConsume(queueName2, true, deliverCallback2, consumerTag -> {
        });
        channel3.basicConsume(queueName3, true, deliverCallback3, consumerTag -> {
        });
    }
}
```

`Headers äº¤æ¢æœº`
ç±»ä¼¼ä¸»é¢˜å’Œç›´æ¥äº¤æ¢æœºï¼Œå¯ä»¥æ ¹æ® headers ä¸­çš„å†…å®¹æ¥æŒ‡å®šå‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—
ç”±äºæ€§èƒ½å·®ã€æ¯”è¾ƒå¤æ‚ï¼Œä¸€èˆ¬ä¸æ¨èä½¿ç”¨ã€‚

AI å­¦ä¹ è¿ç¯é—®ï¼šHeaders äº¤æ¢æœºæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ä¼šç”¨ï¼Ÿæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿæœ‰æ²¡æœ‰ç¤ºä¾‹ä»£ç ï¼Ÿ

1. RabbitMQä¸­çš„Headersäº¤æ¢æœºæ˜¯ä¸€ç§ç‰¹æ®Šçš„äº¤æ¢æœºï¼Œå®ƒå…è®¸ä½ åœ¨å‘é€æ¶ˆæ¯æ—¶æ·»åŠ è‡ªå®šä¹‰çš„headersã€‚Headersäº¤æ¢æœºçš„ä¸»è¦ä½œç”¨æ˜¯æä¾›ä¸€ç§æ›´çµæ´»çš„æ¶ˆæ¯è·¯ç”±æ–¹å¼ï¼Œå®ƒå…è®¸ä½ æ ¹æ®æ¶ˆæ¯çš„headerså­—æ®µæ¥è·¯ç”±æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ä¾èµ–ä¼ ç»Ÿçš„é˜Ÿåˆ—æˆ–äº¤æ¢æœºçš„patternåŒ¹é…ã€‚è¿™ç§æ–¹å¼åœ¨ä¸€äº›å¤æ‚çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚æ¶ˆæ¯çš„è¿‡æ»¤ã€åˆ†ç»„ã€ä¼˜å…ˆçº§å¤„ç†ç­‰ã€‚

   ä½¿ç”¨Headersäº¤æ¢æœºçš„ä¸€ä¸ªå¸¸è§åœºæ™¯æ˜¯åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå½“éœ€è¦å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„æœåŠ¡æ—¶ã€‚é€šè¿‡åœ¨å‘é€æ¶ˆæ¯æ—¶æ·»åŠ headersï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’é¢å¤–çš„ä¿¡æ¯ï¼Œå¦‚æœåŠ¡çš„åç§°ã€ä¼˜å…ˆçº§ã€æ¶ˆæ¯çš„æ¥æºç­‰ã€‚è¿™æ ·ï¼Œæ¯ä¸ªæœåŠ¡å¯ä»¥æ ¹æ®å…¶éœ€è¦è¯»å–å’Œå¤„ç†è¿™äº›headersï¼Œä»è€Œå®ç°æ›´ç»†ç²’åº¦çš„æ§åˆ¶å’Œæ›´çµæ´»çš„æ¶ˆæ¯è·¯ç”±ã€‚

   Headersäº¤æ¢æœºçš„ä¼˜ç‚¹ä¸»è¦æœ‰ï¼š

   1. æ›´åŠ çµæ´»çš„æ¶ˆæ¯è·¯ç”±ï¼šHeadersäº¤æ¢æœºå…è®¸ä½ æ ¹æ®æ¶ˆæ¯çš„headerså­—æ®µè¿›è¡Œè·¯ç”±ï¼Œè€Œä¸ä»…ä»…æ˜¯åŸºäºä¼ ç»Ÿçš„é˜Ÿåˆ—æˆ–äº¤æ¢å™¨çš„patternåŒ¹é…ã€‚
   2. é«˜çº§åˆ«çš„æŠ½è±¡ï¼šHeadersäº¤æ¢æœºæä¾›äº†ä¸€ç§é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œä½¿å¾—æ¶ˆæ¯çš„è·¯ç”±å’Œä¼ é€’æ›´åŠ çµæ´»å’Œæ˜“äºç®¡ç†ã€‚
   3. é€‚ç”¨äºå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼šåœ¨ä¸€äº›å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå¦‚æ¶ˆæ¯è¿‡æ»¤ã€åˆ†ç»„ã€ä¼˜å…ˆçº§å¤„ç†ç­‰ï¼ŒHeadersäº¤æ¢æœºå¯ä»¥æä¾›æ›´å¥½çš„æ”¯æŒã€‚

   ç„¶è€Œï¼ŒHeadersäº¤æ¢æœºä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š

   1. æ€§èƒ½å½±å“ï¼šç”±äºHeadersäº¤æ¢æœºéœ€è¦å¯¹æ¯ä¸ªæ¶ˆæ¯è¿›è¡Œé¢å¤–çš„å¤„ç†ï¼ˆå¦‚è§£æheadersï¼‰ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚
   2. å…¼å®¹æ€§é—®é¢˜ï¼šä¸æ˜¯æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿéƒ½æ”¯æŒHeadersäº¤æ¢æœºã€‚åœ¨ä½¿ç”¨Headersäº¤æ¢æœºä¹‹å‰ï¼Œä½ éœ€è¦ç¡®ä¿ä½ çš„RabbitMQæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åº“éƒ½æ”¯æŒè¿™ä¸ªç‰¹æ€§ã€‚

`RPC`
æ”¯æŒç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥æ¨¡æ‹Ÿ RPC çš„è°ƒç”¨ï¼Œä½†æ˜¯ä¸€èˆ¬æ²¡å¿…è¦ï¼Œç›´æ¥ç”¨ Dubboã€GRPC ç­‰ RPC æ¡†æ¶å°±å¥½äº†ã€‚

å®ç°ä¸€ä¸ªåœºæ™¯æ€»æœ‰æ›´åˆé€‚çš„ã€æ›´ä¸“æ³¨çš„æŠ€æœ¯

##### æ ¸å¿ƒç‰¹æ€§
###### æ¶ˆæ¯è¿‡æœŸæœºåˆ¶
å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/ttl.html
å¯ä»¥ç»™æ¯æ¡æ¶ˆæ¯æŒ‡å®šä¸€ä¸ªæœ‰æ•ˆæœŸï¼Œä¸€æ®µæ—¶é—´å†…æœªè¢«æ¶ˆè´¹è€…å¤„ç†ï¼Œå°±è¿‡æœŸäº†ã€‚
ç¤ºä¾‹åœºæ™¯ï¼šæ¶ˆè´¹è€…ï¼ˆåº“å­˜ç³»ç»Ÿï¼‰æŒ‚äº†ï¼Œä¸€ä¸ªè®¢å• 15 åˆ†é’Ÿè¿˜æ²¡è¢«åº“å­˜ç³»ç»Ÿå¤„ç†ï¼Œè¿™ä¸ªè®¢å•å…¶å®å·²ç»å¤±æ•ˆäº†ï¼Œå“ªæ€•åº“å­˜ç³»ç»Ÿå†æ¢å¤ï¼Œå…¶å®ä¹Ÿä¸ç”¨æ‰£å‡åº“å­˜ã€‚
é€‚ç”¨åœºæ™¯ï¼šæ¸…ç†è¿‡æœŸæ¶ˆæ¯ã€æ¨¡æ‹Ÿå»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°ï¼ˆä¸å¼€ä¼šå‘˜å°±æ…¢é€Ÿï¼‰ã€ä¸“é—¨è®©æŸä¸ªç¨‹åºå¤„ç†è¿‡æœŸè¯·æ±‚

1ï¼‰ç»™é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯æŒ‡å®šè¿‡æœŸæ—¶é—´

```java
Map<String, Object> args = new HashMap<String, Object>();
args.put("x-message-ttl", 60000);
channel.queueDeclare("myqueue", false, false, false, args);
```

![image-20231105132513571](assets/image-20231105132513571.png)
å¦‚æœåœ¨è¿‡æœŸæ—¶é—´å†…ï¼Œè¿˜æ²¡æœ‰æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ‰ä¼šè¿‡æœŸã€‚
æ³¨æ„ï¼Œå¦‚æœæ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹è€…æ¥æ”¶åˆ°ï¼Œä½†æ˜¯æ¶ˆè´¹è€…æ²¡ç¡®è®¤ackï¼Œæ˜¯ä¸ä¼šè¿‡æœŸçš„ã€‚
å¦‚æœæ¶ˆæ¯å¤„äºå¾…æ¶ˆè´¹çŠ¶æ€å¹¶ä¸”è¿‡æœŸæ—¶é—´åˆ°è¾¾åï¼Œæ¶ˆæ¯å°†è¢«æ ‡è®°ä¸ºè¿‡æœŸã€‚ä½†æ˜¯ï¼Œå¦‚æœæ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå¹¶ä¸”æ­£åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå³ä½¿è¿‡æœŸæ—¶é—´åˆ°è¾¾ï¼Œæ¶ˆæ¯ä»ç„¶ä¼šè¢«æ­£å¸¸å¤„ç†ã€‚

ç”Ÿäº§è€…ä»£ç ï¼š

```java
public class AllTTLProducer {

    private final static String QUEUE_NAME = "all-ttl-queue";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç»™é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯æŒ‡å®šè¿‡æœŸæ—¶é—´
            Map<String, Object> args = new HashMap<String, Object>();
            args.put("x-message-ttl", 6000);
            channel.queueDeclare(QUEUE_NAME, false, false, false, args);
            // å‘é€æ¶ˆæ¯
            String message = "Hello World!";
            channel.basicPublish("", QUEUE_NAME, null, message.getBytes(StandardCharsets.UTF_8));
            System.out.println(" [x] Sent '" + message + "'");
        }
    }
}
```

æ¶ˆè´¹è€…ä»£ç ï¼š

```java
public class AllTTLConsumer {

    private final static String QUEUE_NAME = "all-ttl-queue";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒæŒ‡å®šæ¶ˆæ¯è¿‡æœŸå‚æ•°
        Map<String, Object> args = new HashMap<String, Object>();
        args.put("x-message-ttl", 6000);
        channel.queueDeclare(QUEUE_NAME, false, false, false, args);
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
        // å®šä¹‰äº†å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), StandardCharsets.UTF_8);
            System.out.println(" [x] Received '" + message + "'");
        };
        // æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¼šæŒç»­é˜»å¡
        channel.basicConsume(QUEUE_NAME, false, deliverCallback, consumerTag -> {
        });
    }
}
```


2ï¼‰ç»™æŸæ¡æ¶ˆæ¯æŒ‡å®šè¿‡æœŸæ—¶é—´

è¯­æ³•ï¼š

```java
AMQP.BasicProperties properties = new AMQP.BasicProperties.Builder()
                                   .expiration("60000")
                                   .build();
channel.basicPublish("my-exchange", "routing-key", properties, messageBodyBytes);
```

ç”Ÿäº§è€…ä»£ç ï¼š

```java
public class PerTTLProducer {

    private final static String QUEUE_NAME = "per-ttl-queue";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
            channel.queueDeclare(QUEUE_NAME, false, false, false, null);
            // å‘é€æ¶ˆæ¯
            String message = "Hello World!";
            // ç»™å•æ¡æ¶ˆæ¯æŒ‡å®šè¿‡æœŸæ—¶é—´
            AMQP.BasicProperties properties = new AMQP.BasicProperties.Builder()
                    .expiration("6000")
                    .build();
            channel.basicPublish("", QUEUE_NAME, properties, message.getBytes(StandardCharsets.UTF_8));
            System.out.println(" [x] Sent '" + message + "'");
        }
    }
}
```

æ¶ˆè´¹è€…ä»£ç :

```java
public class PerTTLConsumer {

    private final static String QUEUE_NAME = "per-ttl-queue";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
        // å®šä¹‰äº†å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), StandardCharsets.UTF_8);
            System.out.println(" [x] Received '" + message + "'");
        };
        // æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¼šæŒç»­é˜»å¡
        channel.basicConsume(QUEUE_NAME, false, deliverCallback, consumerTag -> {
        });
    }
}
```



###### æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/confirms.html
ä¸ºäº†ä¿è¯æ¶ˆæ¯æˆåŠŸè¢«æ¶ˆè´¹ï¼ˆå¿«é€’æˆåŠŸè¢«å–èµ°ï¼‰ï¼Œrabbitmq æä¾›äº†æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œå½“æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæ¯”å¦‚è¦ç»™ä¸€ä¸ªåé¦ˆï¼š

- ackï¼šæ¶ˆè´¹æˆåŠŸ
- nackï¼šæ¶ˆè´¹å¤±è´¥
- rejectï¼šæ‹’ç»

å¦‚æœå‘Šè¯‰ rabbitmq æœåŠ¡å™¨æ¶ˆè´¹æˆåŠŸï¼ŒæœåŠ¡å™¨æ‰ä¼šæ”¾å¿ƒåœ°ç§»é™¤æ¶ˆæ¯ã€‚
æ”¯æŒé…ç½® autoackï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ ack å‘½ä»¤ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯ç«‹åˆ»å°±æˆåŠŸäº†ã€‚

```java
channel.basicConsume(TASK_QUEUE_NAME, false, deliverCallback, consumerTag -> {});
```

å»ºè®® autoack æ”¹ä¸º falseï¼Œæ ¹æ®å®é™…æƒ…å†µï¼Œå»æ‰‹åŠ¨ç¡®è®¤ã€‚ 
æŒ‡å®šç¡®è®¤æŸæ¡æ¶ˆæ¯ï¼š
ç¬¬äºŒä¸ªå‚æ•° multiple æ‰¹é‡ç¡®è®¤ï¼šæ˜¯æŒ‡æ˜¯å¦è¦ä¸€æ¬¡æ€§ç¡®è®¤æ‰€æœ‰çš„å†å²æ¶ˆæ¯ç›´åˆ°å½“å‰è¿™æ¡

```java
 channel.basicAck(delivery.getEnvelope().getDeliveryTag(),false);
```

æŒ‡å®šæ‹’ç»æŸæ¡æ¶ˆæ¯ï¼š
ç¬¬ 3 ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦é‡æ–°å…¥é˜Ÿï¼Œå¯ç”¨äºé‡è¯•

```java
channel.basicNack(delivery.getEnvelope().getDeliveryTag(),false,false );
```

###### æ­»ä¿¡é˜Ÿåˆ—
å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.rabbitmq.com/dlx.html
ä¸ºäº†ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œæ¯”å¦‚è®©æ¯æ¡æ¶ˆæ¯éƒ½æˆåŠŸæ¶ˆè´¹ï¼Œéœ€è¦æä¾›ä¸€ä¸ªå®¹é”™æœºåˆ¶ï¼Œå³ï¼šå¤±è´¥çš„æ¶ˆæ¯æ€ä¹ˆå¤„ç†ï¼Ÿ
æ­»ä¿¡ï¼šè¿‡æœŸçš„æ¶ˆæ¯ã€æ‹’æ”¶çš„æ¶ˆæ¯ã€æ¶ˆæ¯é˜Ÿåˆ—æ»¡äº†ã€å¤„ç†å¤±è´¥çš„æ¶ˆæ¯çš„ç»Ÿç§°
æ­»ä¿¡é˜Ÿåˆ—ï¼šä¸“é—¨å¤„ç†æ­»ä¿¡çš„é˜Ÿåˆ—ï¼ˆæ³¨æ„ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ™®é€šé˜Ÿåˆ—ï¼Œåªä¸è¿‡æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†æ­»ä¿¡çš„ï¼Œä½ ç”šè‡³å¯ä»¥ç†è§£è¿™ä¸ªé˜Ÿåˆ—çš„åç§°å« â€œæ­»ä¿¡é˜Ÿåˆ—â€ï¼‰
æ­»ä¿¡äº¤æ¢æœºï¼šä¸“é—¨ç»™æ­»ä¿¡é˜Ÿåˆ—è½¬å‘æ¶ˆæ¯çš„äº¤æ¢æœºï¼ˆæ³¨æ„ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ™®é€šäº¤æ¢æœºï¼Œåªä¸è¿‡æ˜¯ä¸“é—¨ç»™æ­»ä¿¡é˜Ÿåˆ—å‘æ¶ˆæ¯è€Œå·²ï¼Œç†è§£ä¸ºè¿™ä¸ªäº¤æ¢æœºçš„åç§°å°±å« â€œæ­»ä¿¡äº¤æ¢æœºâ€ï¼‰ã€‚ä¹Ÿå­˜åœ¨è·¯ç”±ç»‘å®š
æ­»ä¿¡å¯ä»¥é€šè¿‡æ­»ä¿¡äº¤æ¢æœºç»‘å®šåˆ°æ­»ä¿¡é˜Ÿåˆ—ã€‚

ç¤ºä¾‹åœºæ™¯ï¼š
![image-20231105135352929](assets/image-20231105135352929.png)

æµç¨‹ï¼š

è€æ¿æˆ–å¤–åŒ… ç»™ å°çŒ«æˆ–å°ç‹— å‘æ¶ˆæ¯ï¼Œå°çŒ«æˆ–å°ç‹— æ‹’ç»æ¶ˆæ¯ï¼Œæ¶ˆæ¯æˆä¸ºæ­»ä¿¡ï¼Œæ­»ä¿¡å›åˆ° è€æ¿æˆ–å¤–åŒ… çš„æ­»ä¿¡é˜Ÿåˆ—ï¼Œæœ‰è€æ¿æˆ–å¤–åŒ…å»å¤„ç†

ç”Ÿäº§è€…ä»£ç ï¼š

```java
public class DlxDirectProducer {

    private static final String DEAD_EXCHANGE_NAME = "dlx-direct-exchange";
    private static final String WORK_EXCHANGE_NAME = "direct-exchange2";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        try (Connection connection = factory.newConnection();
             Channel channel1 = connection.createChannel();
             Channel channel2 = connection.createChannel();
        ) {
            // åˆ›å»ºæ­»ä¿¡äº¤æ¢æœº
            channel1.exchangeDeclare(DEAD_EXCHANGE_NAME, "direct");
            // åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—
            String queueName1 = "è€æ¿çš„æ­»ä¿¡é˜Ÿåˆ—";
            String queueName2 = "å¤–åŒ…çš„æ­»ä¿¡é˜Ÿåˆ—";
            channel1.queueDeclare(queueName1, true, false, false, null);
            channel2.queueDeclare(queueName2, true, false, false, null);
            // ç»‘å®šæ­»ä¿¡äº¤æ¢æœºï¼ŒæŒ‡å®šè·¯ç”±é”®
            channel1.queueBind(queueName1, DEAD_EXCHANGE_NAME, "è€æ¿");
            channel2.queueBind(queueName2, DEAD_EXCHANGE_NAME, "å¤–åŒ…");
            System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
            // å®šä¹‰äº†è€æ¿å¦‚ä½•å¤„ç†æ­»ä¿¡
            DeliverCallback deliverCallback1 = (consumerTag, delivery) -> {
                String message = new String(delivery.getBody(), "UTF-8");
                System.out.println(" [è€æ¿] Received æ­»ä¿¡ '" +
                        delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
                channel1.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
            };
            // å®šä¹‰äº†å¤–åŒ…å¦‚ä½•å¤„ç†æ­»ä¿¡
            DeliverCallback deliverCallback2 = (consumerTag, delivery) -> {
                String message = new String(delivery.getBody(), "UTF-8");
                System.out.println(" [å¤–åŒ…] Received æ­»ä¿¡ '" +
                        delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
                channel2.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
            };
            // æ¶ˆè´¹æ¶ˆæ¯
            channel1.basicConsume(queueName1, false, deliverCallback1, consumerTag -> {
            });
            channel2.basicConsume(queueName2, false, deliverCallback2, consumerTag -> {
            });

            Scanner sc = new Scanner(System.in);
            while (sc.hasNext()) {
                String userInput = sc.nextLine();
                String[] strings = userInput.split(" ");
                if (strings.length < 1) {
                    continue;
                }
                String message = strings[0];
                // ä»è¾“å…¥è·å–è·¯ç”±é”®
                String routingKey = strings[1];
                // è€æ¿å’Œå¤–åŒ…å‘å·¥ä½œäº¤æ¢æœºå‘æ¶ˆæ¯
                channel1.basicPublish(WORK_EXCHANGE_NAME, routingKey, null, message.getBytes("UTF-8"));
                System.out.println(" [x] Sent '" + message + "' with routing:" + routingKey);
            }
        }
    }
}
```

æ¶ˆè´¹è€…ä»£ç ï¼š

```java
public class DlxDirectConsumer {

    private static final String DEAD_EXCHANGE_NAME = "dlx-direct-exchange";
    private static final String WORK_EXCHANGE_NAME = "direct-exchange2";

    public static void main(String[] argv) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel1 = connection.createChannel();
        Channel channel2 = connection.createChannel();
        // æŒ‡å®šæ­»ä¿¡å‚æ•°
        Map<String, Object> args1 = new HashMap<String, Object>();
        Map<String, Object> args2= new HashMap<String, Object>();
        // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
        args1.put("x-dead-letter-exchange", DEAD_EXCHANGE_NAME);
        args2.put("x-dead-letter-exchange", DEAD_EXCHANGE_NAME);
        // æŒ‡å®šæ­»ä¿¡è¦è½¬å‘åˆ°å“ªä¸ªé˜Ÿåˆ—
        args1.put("x-dead-letter-routing-key", "è€æ¿");
        args2.put("x-dead-letter-routing-key", "å¤–åŒ…");

        // åˆ›å»ºå·¥ä½œäº¤æ¢æœº
        channel1.exchangeDeclare(WORK_EXCHANGE_NAME, "direct");
        // åˆ›å»ºå‘˜å·¥é˜Ÿåˆ—
        String queueName1 = "å°çŒ«çš„å·¥ä½œé˜Ÿåˆ—";
        String queueName2 = "å°ç‹—çš„å·¥ä½œé˜Ÿåˆ—";
        channel1.queueDeclare(queueName1, true, false, false, args1);
        channel2.queueDeclare(queueName2, true, false, false, args2);
        // ç»‘å®šå·¥ä½œäº¤æ¢æœºï¼ŒæŒ‡å®šè·¯ç”±é”®
        channel1.queueBind(queueName1, WORK_EXCHANGE_NAME, "å°çŒ«");
        channel2.queueBind(queueName2, WORK_EXCHANGE_NAME, "å°ç‹—");
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");

        // å®šä¹‰äº†å°çŒ«å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback1 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            //æ‹’ç»æ¶ˆæ¯
            System.out.println(" [å°çŒ«] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
            channel1.basicNack(delivery.getEnvelope().getDeliveryTag(),false,false);
        };
        // å®šä¹‰äº†å°ç‹—å¦‚ä½•å¤„ç†æ¶ˆæ¯
        DeliverCallback deliverCallback2 = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            //æ‹’ç»æ¶ˆæ¯
            System.out.println(" [å°ç‹—] Received '" +
                    delivery.getEnvelope().getRoutingKey() + "':'" + message + "'");
            channel2.basicNack(delivery.getEnvelope().getDeliveryTag(),false,false);
        };
        // æ¶ˆè´¹æ¶ˆæ¯
        channel1.basicConsume(queueName1, false, deliverCallback1, consumerTag -> {
        });
        channel2.basicConsume(queueName2, false, deliverCallback2, consumerTag -> {
        });
    }
}
```

##### RabbitMQ é‡ç‚¹çŸ¥è¯†

ä¹Ÿæ˜¯é¢è¯•è€ƒç‚¹

1. æ¶ˆæ¯é˜Ÿåˆ—çš„æ¦‚å¿µã€æ¨¡å‹ã€åº”ç”¨åœºæ™¯
2. äº¤æ¢æœºçš„ç±»åˆ«ã€è·¯ç”±ç»‘å®šçš„å…³ç³»
3. æ¶ˆæ¯å¯é æ€§
   1. æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆackã€nackã€rejectï¼‰
   2. æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆdurableï¼‰
   3. æ¶ˆæ¯è¿‡æœŸæœºåˆ¶
   4. æ­»ä¿¡é˜Ÿåˆ—
4. å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆç±»ä¼¼æ­»ä¿¡é˜Ÿåˆ—ï¼Œæ¶ˆæ¯åœ¨å·¥ä½œé˜Ÿåˆ—ä¸­ç¡ä¸Š5åˆ†é’Ÿï¼Œç„¶åæ‹’ç»æ¶ˆæ¯ï¼Œæ¶ˆæ¯æˆä¸ºæ­»ä¿¡è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œç„¶ååƒå¤„ç†æ­£å¸¸æ¶ˆæ¯ä¸€æ ·å¤„ç†æ­»ä¿¡ï¼Œå°±è¾¾åˆ°äº†å»¶è¿Ÿæ•ˆæœï¼‰
5. é¡ºåºæ¶ˆè´¹ã€æ¶ˆè´¹å¹‚ç­‰æ€§ï¼ˆæœ¬æ¬¡ä¸è®²ï¼‰
6. å¯æ‰©å±•æ€§ï¼ˆä»…ä½œäº†è§£ï¼‰
   - é›†ç¾¤
   - æ•…éšœçš„æ¢å¤æœºåˆ¶
   - é•œåƒ
7. è¿ç»´ç›‘æ§å‘Šè­¦ï¼ˆä»…ä½œäº†è§£ï¼‰

ç›¸å…³èµ„æºæ¨è
https://juejin.cn/post/7225474899480526885
https://t.zsxq.com/0fq7F1WAa

#### RabbitMQ é¡¹ç›®å®æˆ˜

##### é€‰æ‹©å®¢æˆ·ç«¯
æ€ä¹ˆåœ¨é¡¹ç›®ä¸­ä½¿ç”¨ RabbitMQï¼Ÿ
1ã€ä½¿ç”¨å®˜æ–¹çš„å®¢æˆ·ç«¯ã€‚
ä¼˜ç‚¹ï¼šå…¼å®¹æ€§å¥½ï¼Œæ¢è¯­è¨€æˆæœ¬ä½ï¼Œæ¯”è¾ƒçµæ´»ï¼ˆç±»ä¼¼JDBCï¼‰
ç¼ºç‚¹ï¼šå¤ªçµæ´»ï¼Œè¦è‡ªå·±å»å¤„ç†ä¸€äº›äº‹æƒ…ã€‚æ¯”å¦‚è¦è‡ªå·±ç»´æŠ¤ç®¡ç†é“¾æ¥ï¼Œå¾ˆéº»çƒ¦ã€‚

2ã€ä½¿ç”¨å°è£…å¥½çš„å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚ Spring Boot RabbitMQ Starter
ä¼˜ç‚¹ï¼šç®€å•æ˜“ç”¨ï¼Œç›´æ¥é…ç½®ç›´æ¥ç”¨ï¼Œæ›´æ–¹ä¾¿åœ°å»ç®¡ç†è¿æ¥ï¼ˆç±»ä¼¼MyBatisï¼‰
ç¼ºç‚¹ï¼šå°è£…çš„å¤ªå¥½äº†ï¼Œä½ æ²¡å­¦è¿‡çš„è¯åè€Œä¸çŸ¥é“æ€ä¹ˆç”¨ã€‚ä¸å¤Ÿçµæ´»ï¼Œè¢«æ¡†æ¶é™åˆ¶ã€‚

æœ¬æ¬¡ä½¿ç”¨ Spring Boot RabbitMQ Starter

å»ºè®®çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œä¸è¦çœ‹è¿‡æœŸåšå®¢ï¼
https://spring.io/guides/gs/messaging-rabbitmq/

##### åŸºç¡€å®æˆ˜

1ã€å¼•å…¥ä¾èµ–
æ³¨æ„ï¼Œä½¿ç”¨çš„ç‰ˆæœ¬ä¸€å®šè¦å’Œä½ çš„ springboot ç‰ˆæœ¬ä¸€è‡´ï¼ï¼ï¼ï¼ï¼ï¼ï¼

```xml
<!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-amqp -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
    <version>2.7.2</version>
</dependency>
```

2ã€åœ¨ yml ä¸­å¼•å…¥é…ç½®

```yml
spring:
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
```

3ã€åˆ›å»ºäº¤æ¢æœºå’Œé˜Ÿåˆ—

```java
/**
 * ç”¨äºåˆ›å»ºæµ‹è¯•ç”¨åˆ°çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼ˆåªåœ¨ä¸»ç¨‹åºå¯åŠ¨å‰æ‰§è¡Œä¸€æ¬¡ï¼‰
 */
public class MQInit {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // åˆ›å»ºäº¤æ¢æœº
        String EXCHANGE_NAME = "code-exchange";
        channel.exchangeDeclare(EXCHANGE_NAME,"direct");
        // åˆ›å»ºé˜Ÿåˆ—
        String queueName = "code-queue";
        channel.queueDeclare(queueName, true, false, false, null);
        // ç»‘å®šäº¤æ¢æœºï¼ŒæŒ‡å®šè·¯ç”±é”®
        channel.queueBind(queueName, EXCHANGE_NAME, "code-key");
    }
}
```

4ã€ç”Ÿäº§è€…ä»£ç 

```java
@Component
public class MyMessageProducer {
    @Resource
    private RabbitTemplate rabbitTemplate;

    public void sendMessage(String exchange,String routingKey,String messgae){
        rabbitTemplate.convertAndSend(exchange,routingKey,messgae);
    }
}
```

5ã€æ¶ˆè´¹è€…ä»£ç 

```java
@Component
@Slf4j
public class MyMessageConsumer {
    @Resource
    private RabbitTemplate rabbitTemplate;

    //æŒ‡å®šç¨‹åºç›‘å¬çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œç¡®è®¤æœºåˆ¶
    @RabbitListener(queues = {"code-queue"}, ackMode = "MANUAL")
    public void receiveMessage(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag)
            throws IOException {
        log.info("receiveMessage message={}", message);
        channel.basicAck(deliveryTag, false);
    }
}
```

6ã€å•å…ƒæµ‹è¯•æ‰§è¡Œ

```java
@SpringBootTest
class MyMessageProducerTest {
    @Resource
    private MyMessageProducer myMessageProducer;

    /**
     * å…ˆå¯åŠ¨SpringBooté¡¹ç›®ï¼Œå†æ‰§è¡Œè¯¥æµ‹è¯•
     */
    @Test
    void sendMessage() {
        myMessageProducer.sendMessage("code-exchange", "code-key", "ä½ å¥½");
    }
}
```

##### BI é¡¹ç›®æ”¹é€ 
ä»¥å‰æ˜¯æŠŠä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ï¼Œç„¶ååœ¨çº¿ç¨‹æ± æäº¤ä¸­ç¼–å†™å¤„ç†ç¨‹åºçš„ä»£ç ï¼Œçº¿ç¨‹æ± å†…æ’é˜Ÿã€‚
å¦‚æœä¸»ç¨‹åºä¸­æ–­äº†ï¼Œä»»åŠ¡å°±æ²¡äº†ï¼Œå°±ä¸¢äº†ã€‚

`æ”¹é€ åçš„æµç¨‹ï¼š`

1. æŠŠä»»åŠ¡æäº¤æ”¹ä¸ºå‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯
2. å†™ä¸€ä¸ªä¸“é—¨çš„æ¥å—æ¶ˆæ¯çš„ç¨‹åºï¼Œå¤„ç†ä»»åŠ¡
3. å¦‚æœç¨‹åºä¸­æ–­äº†ï¼Œæ¶ˆæ¯æœªè¢«ç¡®è®¤ï¼Œè¿˜ä¼šé‡å‘
4. ç°åœ¨ï¼Œæ¶ˆæ¯å…¨éƒ¨é›†ä¸­å‘åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½ å¯ä»¥éƒ¨ç½²å¤šä¸ªåç«¯ï¼Œéƒ½ä»åŒä¸€ä¸ªåœ°æ–¹å–ä»»åŠ¡ï¼Œä»è€Œå®ç°äº†åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡

`å®ç°æ­¥éª¤`
1ï¼‰åˆ›å»ºäº¤æ¢æœºå’Œé˜Ÿåˆ—
2ï¼‰å°†çº¿ç¨‹æ± ä¸­çš„æ‰§è¡Œä»£ç ç§»åˆ°æ¶ˆè´¹è€…ç±»ä¸­
3ï¼‰æ ¹æ®æ¶ˆè´¹è€…çš„éœ€æ±‚æ¥ç¡®è®¤æ¶ˆæ¯çš„æ ¼å¼ï¼ˆchartIdï¼‰
4ï¼‰å°†æäº¤çº¿ç¨‹æ± æ”¹é€ ä¸ºå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—

```java
public class BIMQConstant {
    public static final String BI_EXCHANGE_NAME = "bi-exchange";

    public static final String BI_QUEUE_NAME = "bi-queue";

    public static final String BI_ROUTING_KEY = "bi-key";
}
```

```java
/**
 * ç”¨äºåˆ›å»ºæµ‹è¯•ç”¨åˆ°çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼ˆåªåœ¨ä¸»ç¨‹åºå¯åŠ¨å‰æ‰§è¡Œä¸€æ¬¡ï¼‰
 */
public class BIMQInit {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºè¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        // å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºé¢‘é“
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // åˆ›å»ºäº¤æ¢æœº
        String EXCHANGE_NAME = BIMQConstant.BI_EXCHANGE_NAME;
        channel.exchangeDeclare(EXCHANGE_NAME,"direct");
        // åˆ›å»ºé˜Ÿåˆ—
        String queueName = BIMQConstant.BI_QUEUE_NAME;
        channel.queueDeclare(queueName, true, false, false, null);
        // ç»‘å®šäº¤æ¢æœºï¼ŒæŒ‡å®šè·¯ç”±é”®
        channel.queueBind(queueName, EXCHANGE_NAME, BIMQConstant.BI_ROUTING_KEY);
    }
}
```

```java
@Component
public class BIMessageProducer {
    @Resource
    private RabbitTemplate rabbitTemplate;

    /**
     * å‘é€æ¶ˆæ¯
     * @param messgae
     */
    public void sendMessage(String messgae){
        rabbitTemplate.convertAndSend(BIMQConstant.BI_EXCHANGE_NAME,BIMQConstant.BI_ROUTING_KEY,messgae);
    }
}
```

```java
@Component
@Slf4j
public class BIMessageConsumer {

    @Resource
    private ChartService chartService;

    @Resource
    private AIManager aiManager;

    //æŒ‡å®šç¨‹åºç›‘å¬çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œç¡®è®¤æœºåˆ¶
    @RabbitListener(queues = {BIMQConstant.BI_QUEUE_NAME}, ackMode = "MANUAL")
    public void receiveMessage(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag)
            throws IOException {
        if (StringUtils.isBlank(message)){
            channel.basicNack(deliveryTag,false,false);
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"æ¶ˆæ¯ä¸ºç©º");

        }
        long chartId = Long.parseLong(message);
        Chart chart = chartService.getById(chartId);
        if (chart==null){
            channel.basicNack(deliveryTag,false,false);
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"æ¶ˆæ¯ä¸ºç©º");
        }
        //å…ˆä¿®æ”¹å›¾è¡¨çš„ä»»åŠ¡çŠ¶æ€ä¸ºâ€œæ‰§è¡Œä¸­â€ï¼›ç­‰æ‰§è¡ŒæˆåŠŸåï¼Œä¿®æ”¹ä¸ºâ€œå·²å®Œæˆâ€ï¼Œä¿å­˜æ‰§è¡Œç»“æœï¼›æ‰§è¡Œå¤±è´¥åï¼Œä¿®æ”¹ä¸ºå¤±è´¥ï¼Œè®°å½•å¤±è´¥ä¿¡æ¯
        //ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ä¸ºæ‰§è¡Œä¸­ï¼Œå‡å°‘é‡å¤æ‰§è¡Œçš„é£é™©ã€åŒæ—¶è®©ç”¨æˆ·çŸ¥æ™“æ‰§è¡ŒçŠ¶æ€
        Chart updateChart = new Chart();
        updateChart.setId(chart.getId());
        updateChart.setStatus("running");
        boolean result = chartService.updateById(updateChart);
        if (!result) {
            channel.basicNack(deliveryTag,false,false);
            handleChartUpdateError(chart.getId(), "æ›´æ–°å›¾è¡¨æ‰§è¡Œä¸­çŠ¶æ€å¤±è´¥");
            return;
        }
        // è°ƒç”¨é±¼èªæ˜SDKï¼Œå¾—åˆ°å“åº”

        String answer = aiManager.doChat(CommonConstant.BI_MODEL_ID, buildUserInput(chart));
        // ä»AIå“åº”ç»“æœä¸­ï¼Œå–å‡ºéœ€è¦çš„æ•°æ®
        String[] splits = answer.split("ã€ã€ã€ã€ã€");
        if (splits.length < 3) {
            channel.basicNack(deliveryTag,false,false);
            handleChartUpdateError(chart.getId(), "AIç”Ÿæˆé”™è¯¯");
            return;
        }
        String genChart = splits[1].trim();
        String genSummary = splits[2].trim();
        //æ‰§è¡ŒæˆåŠŸ
        Chart updateChartResult = new Chart();
        updateChartResult.setId(chart.getId());
        //todo å»ºè®®å®šä¹‰çŠ¶æ€ä¸ºæšä¸¾å€¼
        updateChartResult.setStatus("succeeded");
        updateChartResult.setGenChart(genChart);
        updateChartResult.setGenSummary(genSummary);
        result = chartService.updateById(updateChartResult);
        if (!result) {
            channel.basicNack(deliveryTag,false,false);
            handleChartUpdateError(chart.getId(), "æ›´æ–°å›¾è¡¨å·²å®ŒæˆçŠ¶æ€å¤±è´¥");
            return;
        }
        //ç¡®è®¤æ¶ˆæ¯
        channel.basicAck(deliveryTag, false);
    }

    private void handleChartUpdateError(long chartId, String execMessage) {
        Chart updateChart = new Chart();
        updateChart.setId(chartId);
        updateChart.setStatus("failed");
        updateChart.setExecMessage(execMessage);
        boolean result = chartService.updateById(updateChart);
        if (!result) {
            log.error("æ›´æ–°å›¾è¡¨å¤±è´¥çŠ¶æ€å¤±è´¥ï¼Œ" + chartId + "ï¼Œ" + execMessage);
        }
    }
    /**
     * æ„é€ ç”¨æˆ·è¯·æ±‚
     * @param chart
     * @return
     */	
    private String buildUserInput(Chart chart) {
        String goal = chart.getGoal();
        String data = chart.getRawData();
        // æ„é€ ç”¨æˆ·è¯·æ±‚ï¼ˆåˆ†æç›®æ ‡ï¼Œå›¾è¡¨åç§°ï¼Œå›¾è¡¨ç±»å‹ï¼Œcsvæ•°æ®ï¼‰
        StringBuilder userInput = new StringBuilder();
        userInput.append("åˆ†æéœ€æ±‚ï¼š").append("\n");
        userInput.append(goal).append("\n");
        userInput.append("åŸå§‹æ•°æ®ï¼š").append("\n");
        userInput.append(data).append("\n");
        return userInput.toString();
    }
}
```

```java
/**
 * æ™ºèƒ½åˆ†æï¼ˆå¼‚æ­¥&æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
 *
 * @param multipartFile
 * @param genChartRequest
 * @param request
 * @return
 */
@PostMapping("/gen")
public BaseResponse<BIResponse> genChartByAI(@RequestPart("file") MultipartFile multipartFile,
                                             GenChartRequest genChartRequest, HttpServletRequest request) {
    String goal = genChartRequest.getGoal();
    String chartType = genChartRequest.getChartType();
    String chartName = genChartRequest.getChartName();
    // æ‹¼æ¥åˆ†æç›®æ ‡
    if (StringUtils.isNotBlank(chartType)) {
        goal = goal + "ï¼Œè¯·ä½¿ç”¨" + chartType;
    }
    // æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(StringUtils.isBlank(goal), ErrorCode.PARAMS_ERROR, "åˆ†æç›®æ ‡ä¸ºç©º");
    ThrowUtils.throwIf(StringUtils.isNotBlank(chartName) && chartName.length() > 128, ErrorCode.PARAMS_ERROR, "å›¾è¡¨åç§°è¿‡é•¿");
    // æ ¡éªŒæ–‡ä»¶
    long size = multipartFile.getSize();
    String originalFilename = multipartFile.getOriginalFilename();
    // æ ¡éªŒæ–‡ä»¶å¤§å°
    final long ONE_MB = 1024 * 1024L;
    ThrowUtils.throwIf(size > ONE_MB, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°è¶…è¿‡ 1M");
    // æ ¡éªŒæ–‡ä»¶åç¼€
    String suffix = FileUtil.getSuffix(originalFilename);
    final List<String> validFileSuffix = Arrays.asList("xlsx");
    ThrowUtils.throwIf(!validFileSuffix.contains(suffix), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶åç¼€ä¸ç¬¦åˆè¦æ±‚");
    // è·å–ç™»å½•ç”¨æˆ·
    User loginUser = userService.getLoginUser(request);
    // é™æµ,æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªé™æµå™¨
    redisLimiterManager.doRateLimit("genChartByAI_" + loginUser.getId().toString());
    // å‹ç¼©åŸå§‹æ•°æ®
    String data = ExcelUtils.excelToCsv(multipartFile);
    // æ’å…¥æ•°æ®åº“
    Chart chart = new Chart();
    chart.setGoal(goal);
    chart.setRawData(data);
    chart.setChartType(chartType);
    chart.setChartName(chartName);
    chart.setUserId(loginUser.getId());
    chart.setStatus("wait");
    boolean save = chartService.save(chart);
    ThrowUtils.throwIf(!save, ErrorCode.SYSTEM_ERROR, "å›¾è¡¨ä¿å­˜å¤±è´¥");
    // todo å¤„ç†ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†åï¼ŒæŠ›å¼‚å¸¸çš„æƒ…å†µ
    // å‘é€æ¶ˆæ¯ï¼ˆå›¾è¡¨idï¼‰,ä¸»è¦æ˜¯æ³¨æ„åˆ°è°ƒç”¨aiéœ€è¦çš„æ•°æ®éƒ½ä¿å­˜åˆ°å›¾è¡¨æ•°æ®åº“äº†
    biMessageProducer.sendMessage(String.valueOf(chart.getId()));
    // è¿”å›ç»™å‰ç«¯
    BIResponse biResponse = new BIResponse();
    biResponse.setChartId(chart.getId());
    return ResultUtils.success(biResponse);
}
```

`éªŒè¯`
éªŒè¯å‘ç°ï¼Œå¦‚æœç¨‹åºä¸­æ–­äº†ï¼Œæ²¡æœ‰ ackã€ä¹Ÿæ²¡æœ‰ nackï¼ˆæœåŠ¡ä¸­æ–­ï¼Œæ²¡æœ‰ä»»ä½•å“åº”ï¼‰ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯ä¼šè¢«é‡æ–°æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä»è€Œå®ç°äº†æ¯ä¸ªä»»åŠ¡éƒ½ä¼šæ‰§è¡Œã€‚

`å±•ç¤º`

![image-20231105164432598](assets/image-20231105164432598.png)

![image-20231105164441712](assets/image-20231105164441712.png)

![image-20231105164900726](assets/image-20231105164900726.png)

![image-20231105164909224](assets/image-20231105164909224.png)

##### é¡¹ç›®æ‰©å±•

ä¼˜åŒ–ç‚¹

1. ç»™ä»»åŠ¡çš„æ‰§è¡Œå¢åŠ  guava Retrying é‡è¯•æœºåˆ¶ï¼Œä¿è¯ç³»ç»Ÿå¯é æ€§ã€‚
2. æå‰è€ƒè™‘åˆ° AI ç”Ÿæˆé”™è¯¯çš„æƒ…å†µï¼Œåœ¨åç«¯è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼ˆæ¯”å¦‚ AI è¯´äº†å¤šä½™çš„è¯ï¼Œæå–æ­£ç¡®çš„å­—ç¬¦ä¸²ï¼‰
3. å¦‚æœè¯´ä»»åŠ¡æ ¹æœ¬æ²¡æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼ˆæˆ–è€…é˜Ÿåˆ—æ»¡äº†ï¼‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç”¨å®šæ—¶ä»»åŠ¡æŠŠå¤±è´¥çŠ¶æ€çš„å›¾è¡¨æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼ˆè¡¥å¿ï¼‰
4. å»ºè®®ç»™ä»»åŠ¡çš„æ‰§è¡Œå¢åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶è‡ªåŠ¨æ ‡è®°ä¸ºå¤±è´¥ï¼ˆè¶…æ—¶æ§åˆ¶ï¼‰
5. åå‘å‹åŠ›ï¼šhttps://zhuanlan.zhihu.com/p/404993753ï¼Œé€šè¿‡è°ƒç”¨çš„æœåŠ¡çŠ¶æ€æ¥é€‰æ‹©å½“å‰ç³»ç»Ÿçš„ç­–ç•¥ï¼ˆæ¯”å¦‚æ ¹æ® AI æœåŠ¡çš„å½“å‰ä»»åŠ¡é˜Ÿåˆ—æ•°æ¥æ§åˆ¶å’±ä»¬ç³»ç»Ÿçš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰ï¼Œä»è€Œæœ€å¤§åŒ–åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚
6. æˆ‘çš„å›¾è¡¨é¡µé¢å¢åŠ ä¸€ä¸ªåˆ·æ–°ã€å®šæ—¶è‡ªåŠ¨åˆ·æ–°çš„æŒ‰é’®ï¼Œä¿è¯è·å–åˆ°å›¾è¡¨çš„æœ€æ–°çŠ¶æ€ï¼ˆå‰ç«¯è½®è¯¢ï¼‰
7. ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥ï¼Œç»™ç”¨æˆ·å‘é€å®æ—¶æ¶ˆæ¯é€šçŸ¥ï¼ˆå®æ—¶ï¼šwebsocketã€server side eventï¼‰

æ›´å¤šä¼˜åŒ–ç‚¹

1. æ”¯æŒç”¨æˆ·æŸ¥çœ‹å›¾è¡¨åŸå§‹æ•°æ®
2. å›¾è¡¨æ•°æ®åˆ†è¡¨å­˜å‚¨ï¼Œæé«˜æŸ¥è¯¢çµæ´»æ€§å’Œæ€§èƒ½
3. æ”¯æŒåˆ†ç»„ï¼ˆåˆ†æ ‡ç­¾ï¼‰æŸ¥çœ‹å’Œæ£€ç´¢å›¾è¡¨
4. å¢åŠ æ›´å¤šå¯é€‰å‚æ•°æ¥æ§åˆ¶å›¾è¡¨çš„ç”Ÿæˆï¼Œæ¯”å¦‚å›¾è¡¨é…è‰²ç­‰
5. æ”¯æŒç”¨æˆ·å¯¹å¤±è´¥çš„å›¾è¡¨è¿›è¡Œæ‰‹åŠ¨é‡è¯•
6. é™åˆ¶ç”¨æˆ·åŒæ—¶ç”Ÿæˆå›¾è¡¨çš„æ•°é‡ï¼Œé˜²æ­¢å•ç”¨æˆ·æŠ¢å ç³»ç»Ÿèµ„æº
7. ç»Ÿè®¡ç”¨æˆ·ç”Ÿæˆå›¾è¡¨çš„æ¬¡æ•°ï¼Œç”šè‡³å¯ä»¥æ·»åŠ ç§¯åˆ†ç³»ç»Ÿï¼Œæ¶ˆè€—ç§¯åˆ†æ¥æ™ºèƒ½åˆ†æ
8. æ”¯æŒç¼–è¾‘ç”Ÿæˆåçš„å›¾è¡¨çš„ä¿¡æ¯ã€‚æ¯”å¦‚å¯ä»¥ä½¿ç”¨ä»£ç ç¼–è¾‘å™¨æ¥ç¼–è¾‘ Echarts å›¾è¡¨é…ç½®ä»£ç 
9. ç”±äºå›¾è¡¨æ•°æ®æ˜¯é™æ€çš„ï¼Œå¾ˆé€‚åˆä½¿ç”¨ç¼“å­˜æ¥æé«˜åŠ è½½é€Ÿåº¦ã€‚
10. ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ—æ¥å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œå°†å›¾è¡¨ç”Ÿæˆä»»åŠ¡ç½®ä¸ºå¤±è´¥
11. è¡¥å……ä¼ ç»Ÿ BI æ‹¥æœ‰çš„åŠŸèƒ½ï¼ŒæŠŠæ™ºèƒ½åˆ†æä½œä¸ºå…¶ä¸­ä¸€ä¸ªå­æ¨¡å—ã€‚



## å‰ç«¯

### è‡ªåŠ¨ç”Ÿæˆåç«¯è°ƒç”¨ä»£ç 

![image-20231031161114725](assets/image-20231031161114725.png)

![image-20231031161044255](assets/image-20231031161044255.png)

![image-20231031161225991](assets/image-20231031161225991.png)

![image-20231031160739020](assets/image-20231031160739020.png)

### ä¿®æ”¹requestErrorConfig

![image-20231101104428242](assets/image-20231101104428242.png)

![image-20231101104452851](assets/image-20231101104452851.png)

![image-20231101105205945](assets/image-20231101105205945.png)

![image-20231101105346669](assets/image-20231101105346669.png)

![image-20231101105418575](assets/image-20231101105418575.png)

### ç™»å½•æ³¨å†Œé¡µé¢

#### ç™»å½•é¡µé¢

1. **ä¿®æ”¹é¡µé¢**

![image-20231101093859849](assets/image-20231101093859849.png)

![image-20231101094604170](assets/image-20231101094604170.png)

![image-20231101094805356](assets/image-20231101094805356.png)

![image-20231101095024190](assets/image-20231101095024190.png)

![image-20231101095351698](assets/image-20231101095351698.png)

![image-20231101095905454](assets/image-20231101095905454.png)

![image-20231101100628266](assets/image-20231101100628266.png)

![image-20231101100753049](assets/image-20231101100753049.png)

![image-20231101100921671](assets/image-20231101100921671.png)

![image-20231101102635469](assets/image-20231101102635469.png)

![image-20231101102712922](assets/image-20231101102712922.png)

![image-20231101111107730](assets/image-20231101111107730.png)

2. **å‘åç«¯å‘èµ·ç™»å½•è¯·æ±‚**

![image-20231101101745533](assets/image-20231101101745533.png)

[åœ¨ant-designä¸­å¦‚ä½•åˆ©ç”¨ä»£ç è‡ªåŠ¨åˆ·æ–°å½“å‰é¡µé¢_antd proä¸­é¡µé¢åˆ·æ–°çš„api-CSDNåšå®¢](https://blog.csdn.net/qq_40372395/article/details/80893453)

![image-20231101141243964](assets/image-20231101141243964.png)

![image-20231101105748685](assets/image-20231101105748685.png)

3. **ä¿®æ”¹app.tsxæ–‡ä»¶**

![image-20231101110537183](assets/image-20231101110537183.png)

![image-20231101110613918](assets/image-20231101110613918.png)

![image-20231101111152663](assets/image-20231101111152663.png)

![image-20231101134723132](assets/image-20231101134723132.png)

#### æ³¨å†Œé¡µé¢

å¤åˆ¶ç™»é™†é¡µé¢ä¿®æ”¹ï¼Œå†æ·»åŠ æ³¨å†Œé¡µé¢çš„è·¯ç”±

![image-20231101134403032](assets/image-20231101134403032.png)

![image-20231101134739225](assets/image-20231101134739225.png)

#### é€€å‡ºç™»å½•

![image-20231101140309845](assets/image-20231101140309845.png)

![image-20231101141545088](assets/image-20231101141545088.png)

![image-20231101140401063](assets/image-20231101140401063.png)

![image-20231101140432402](assets/image-20231101140432402.png)

![image-20231101140559979](assets/image-20231101140559979.png)

### æ™ºèƒ½å›¾è¡¨åˆ†æé¡µé¢

1. ç”¨æˆ·è¾“å…¥
   1. åˆ†æç›®æ ‡
   2. ä¸Šä¼ åŸå§‹æ•°æ®ï¼ˆexcelï¼‰
   3. æ›´ç²¾ç»†åŒ–çš„æ§åˆ¶å›¾è¡¨ï¼šæ¯”å¦‚å›¾è¡¨ç±»å‹ï¼Œå›¾è¡¨åç§°ç­‰
2. å±•ç¤º
   1. å±•ç¤ºä»åç«¯è·å¾—çš„å›¾è¡¨å’Œç»“è®º

**1ã€è‡ªåŠ¨ç”Ÿæˆåç«¯è°ƒç”¨ä»£ç **

**2ã€åˆ›å»ºé¡µé¢**

![image-20231103152845702](assets/image-20231103152845702.png)

**3ã€æ·»åŠ è·¯ç”±**

![image-20231103153006971](assets/image-20231103153006971.png)

**4ã€ç”¨æˆ·è¾“å…¥**

1. é€‰æ‹©ç»„ä»¶

![image-20231103145354640](assets/image-20231103145354640.png)

![image-20231103145455990](assets/image-20231103145455990.png)

![image-20231103145518854](assets/image-20231103145518854.png)

2. å¼•å…¥ç»„ä»¶

![image-20231103181144202](assets/image-20231103181144202.png)

![image-20231102203513905](assets/image-20231102203513905.png)

![image-20231102203553926](assets/image-20231102203553926.png)

![image-20231102203626446](assets/image-20231102203626446.png)

![image-20231102203701102](assets/image-20231102203701102.png)

![image-20231102203751293](assets/image-20231102203751293.png)

**4ã€å›¾è¡¨å±•ç¤º** https://github.com/hustcc/echarts-for-react  https://git.hust.cc/echarts-for-react/

![image-20231102203834196](assets/image-20231102203834196.png)

![image-20231102202549740](assets/image-20231102202549740.png)

### ä¸ªäººå›¾è¡¨é¡µé¢

**1.åˆ›å»ºé¡µé¢**

![image-20231103155522380](assets/image-20231103155522380.png)

**2ã€æ·»åŠ è·¯ç”±**

![image-20231103153629589](assets/image-20231103153629589.png)

**3ã€è·å–æ•°æ®ï¼Œå®šä¹‰ state å˜é‡æ¥å­˜å‚¨æ•°æ®ï¼Œç”¨äºç»™é¡µé¢å±•ç¤º**

![image-20231103172437291](assets/image-20231103172437291.png)

![image-20231103162350923](assets/image-20231103162350923.png)

![image-20231104131721650](assets/image-20231104131721650.png)

![image-20231103161951719](assets/image-20231103161951719.png)

**4ã€é€‰æ‹©ç»„ä»¶**

![image-20231103162714889](assets/image-20231103162714889.png)

**5ã€å¼•å…¥ç»„ä»¶**

![image-20231103172159876](assets/image-20231103172159876.png)

![image-20231103172331765](assets/image-20231103172331765.png)

![image-20231103173125126](assets/image-20231103173125126.png)

**6ã€æ·»åŠ åˆ†é¡µ**

![image-20231103174145626](assets/image-20231103174145626.png)

**7ã€æ·»åŠ æœç´¢æ¡†**

![image-20231103175128062](assets/image-20231103175128062.png)

![image-20231103175103464](assets/image-20231103175103464.png)

**8ã€è®¾ç½®loading**

![image-20231103180537559](assets/image-20231103180537559.png)

![image-20231103180521767](assets/image-20231103180521767.png)

![image-20231103180604913](assets/image-20231103180604913.png)

![image-20231103180620196](assets/image-20231103180620196.png)

**9ã€åŸå­åŒ–æ ·å¼**

![image-20231103180738768](assets/image-20231103180738768.png)

![image-20231103180802775](assets/image-20231103180802775.png)

**10ã€å±•ç¤º**

![image-20231103181323718](assets/image-20231103181323718.png)

**11ã€æ‰©å±•ç‚¹**

æ”¯æŒç”¨æˆ·æŸ¥çœ‹åŸå§‹æ•°æ®

æ”¯æŒè·³è½¬åˆ°iå›¾è¡¨ç¼–è¾‘é¡µï¼Œå»ç¼–è¾‘å›¾è¡¨

**12ã€ä¿®æ”¹é¡µé¢ï¼Œè¡¥å……é”™è¯¯å¤„ç†**

![image-20231104171643817](assets/image-20231104171643817.png)

![image-20231104171524857](assets/image-20231104171524857.png)

![image-20231104171553609](assets/image-20231104171553609.png)

![image-20231104172425764](assets/image-20231104172425764.png)

![image-20231104172450541](assets/image-20231104172450541.png)

![image-20231104172205864](assets/image-20231104172205864.png)

![image-20231104172216748](assets/image-20231104172216748.png)

### æ™ºèƒ½å›¾è¡¨å¼‚æ­¥åˆ†æé¡µé¢

**æ·»åŠ è·¯ç”±**

![image-20231104172713809](assets/image-20231104172713809.png)

**åˆ›å»ºé¡µé¢**

![image-20231104164128546](assets/image-20231104164128546.png)

**ä¿®æ”¹é¡µé¢**

![image-20231104164254448](assets/image-20231104164254448.png)

![image-20231104164327356](assets/image-20231104164327356.png)

![image-20231104165742419](assets/image-20231104165742419.png)

![image-20231104165822210](assets/image-20231104165822210.png)

![image-20231104165837769](assets/image-20231104165837769.png)

## Ant Design Proè¸©å‘

1. é¡µé¢å¦‚æœä¸€ç›´åŠ è½½ï¼Œåˆ æ‰no de_modulesï¼Œé‡æ–°å®‰è£…ä¾èµ–

2. nodejsç‰ˆæœ¬å»ºè®®16

3. æƒé™ä¸å¤Ÿå°±åˆ‡ç®¡ç†å‘˜

4. æäº¤ä»£ç 

   ```
   git commit --no-verify -m 'your message'
   ```


## Windowså‘½ä»¤

```sh
#æŸ¥çœ‹Windows Hyper-V è™šæ‹ŸåŒ–å¹³å°å ç”¨äº†å“ªäº›èŒƒå›´å†…çš„ç«¯å£
netsh interface ipv4 show excludedportrange protocol=tcp
```

![image-20231031202852991](assets/image-20231031202852991.png)
